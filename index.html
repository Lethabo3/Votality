<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G7WREYHFF7"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'G-G7WREYHFF7');
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votality</title>
    <link rel="icon" href="b2.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=General+Sans:wght@400&display=swap" rel="stylesheet"> <!-- Add this line -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="index.css">

</head>
<body>
    <nav class="desktop-top-nav">   
        <div class="desktop-top-nav__left">
            <span id="user-fullname" class="desktop-top-nav__username">Guest</span>
        </div>
        <div class="desktop-top-nav__center">
            <span id="chat-topic" class="desktop-top-nav__topic">Current Chat Topic</span>
                    </div>
        <div class="desktop-top-nav__right">
            <button class="desktop-top-nav__share-button">Share</button>
        </div>
    </nav>
    
    <!-- Add top navigation for mobile -->
<nav class="top-nav" style="display: none;">
    <a href="index.html">
        <picture class="logo-container">
            <source srcset="v-white.png" media="(prefers-color-scheme: dark)">
            <img src="v.png" alt="Votality AI Logo" class="top-nav__logo">
        </picture>
    </a>        <div class="top-nav__buttons">
        <a href="signin.html" class="top-nav__button top-nav__button--signin">Sign In</a>
        <a href="signup.html" class="top-nav__button top-nav__button--signup">Sign Up</a>
    </div>
</nav>

<!-- Add this right after the opening <body> tag -->
    <button type="button" class="sidebar-toggle" data-tooltip="Expand">
        <i data-lucide="columns" class="h-5 w-5" style="color: #666;"></i>
    </button>
    
<div class="layout">
        <aside class="sidebar">
            <img src="y7.png" alt="Votality AI Logo" class="sidebar__logo">
            <i data-lucide="chevron-first" class="collapse-arrow h-5 w-5" data-tooltip="Collapse"></i>

        <!-- New Chat Button -->
        <div class="sidebar-button-container">
            <i data-lucide="pen-square" style="color: #000; width: 20px; height: 20px;"></i>       <span class="new-thread-text">New Chat</span>
        </div>
        <div class="sidebar-button-container" data-feedback onclick="window.location.href='feedback.html'">
            <i data-lucide="flag" style="color: #000; width: 20px; height: 20px;"></i>
            <span class="new-thread-text">Feedback</span>
        </div>

                    <div class="recent-chats-container">
                        <h3 class="recent-chats-title">Recents</h3>
                        <div class="chat-list">
                            <!-- Dynamic content will be inserted here -->
                        </div>
                    </div>
        
            <div id="sidebar-container">
                <div id="try-pro-container" style="display: none;">
                    <div class="try-pro-container">
                        <div class="try-pro-title">Try Pro</div>
                        <div class="try-pro-description">Upgrade for image upload, smarter AI, and more Analysis.</div>
                        <a href="pricing.html" class="learn-more-link">
                            Learn More
                            <i data-lucide="arrow-up-right" class="h-3 w-3"></i>
                        </a>
                </div>
               </div>
               <div id="account-container" style="display: none;">
                <div class="account-container sidebar__account">
                    <i data-lucide="user" class="h-5 w-5 text-gray-400" data-lucide="user-fill"></i>
                    <span class="sidebar-text user-name">Guest</span>
                </div>
            </div>  
                <div id="guest-buttons-container">
                    <a href="signup.html" id="signup-button">
                        Sign Up
                    </a>
                    <a href="signin.html" id="login-button">
                        Log in
                    </a>
                </div>
            </div>
        </aside>

    <div id="account-panel" class="account-panel">
        <div class="account-panel-header">
            <div class="user-icon">
                <i data-lucide="user" class="h-5 w-5 text-gray-400" data-lucide="user-fill"></i>
            </div>
            <div class="user-info">
                <span id="user-email" class="user-email">user@example.com</span>
                <span id="user-plan" class="user-plan">Free Plan</span>
            </div>
        </div>
        <div class="account-panel-content">
            <a href="pricing.html" id="billing-btn" class="panel-button">
                <div class="panel-button-content">
                    Billing
                </div>
                <i data-lucide="chevron-right" class="panel-button-arrow"></i>
            </a>
            <button id="appearance-btn" class="panel-button">
                <div class="panel-button-content">
                    Appearance
                </div>
            </button>
            <button id="learn-more-btn" class="panel-button">
                <div class="panel-button-content">
                    Learn More
                </div>
                <i data-lucide="chevron-right" class="panel-button-arrow"></i>
            </button>
            <button id="help-support-btn" class="panel-button">
                <div class="panel-button-content">
                    Help & Support
                </div>
                <i data-lucide="chevron-right" class="panel-button-arrow"></i>
            </button>
            <button id="logout-btn" class="panel-button">
                <div class="panel-button-content">
                    Logout
                </div>
            </button>
        </div>
        <div class="account-panel-footer">
            <button id="upgrade-plan-btn" class="upgrade-btn">Upgrade Plan</button>
        </div>
    </div>
    
    <main class="main-content">
        <section class="hero">
            <div id="initial-content">
                <h1 class="hero__title">What do you want to learn?</h1>
                <h2 class="subtitle">Your journey to market knowledge starts here.</h2> <!-- Added subtitle -->
            </div>
            <div id="textarea-container" class="textarea-container">
                <textarea id="query-input" class="textarea-input" placeholder="Ask Votality anything..."></textarea>
                
    <div class="relative">
        <button type="button" class="type-button" class="focus:outline-none">
            <div class="custom-rounded bg-gray-100 p-1.5 hover:bg-gray-200 transition-colors duration-200">
                <span id="selected-type" class="text-sm text-gray-500">Overview</span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-4 w-4 text-gray-500">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
        </button>
        <div class="dropdown-content">
            <div class="dropdown-item">Overview</div>
            <div class="dropdown-item">Financials</div>
            <div class="dropdown-item">Technicals</div>
            <div class="dropdown-item">News</div>
        </div>
    </div>
            
                <button id="submit-button" class="focus:outline-none" style="position: absolute; right: 10px; bottom: 15px; transform: none; background-color: transparent; border: none; cursor: pointer; z-index: 10;">
                    <div class="custom-rounded bg-gray-100 p-1.5 hover:bg-gray-200 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-4 w-4 text-gray-300">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                        </svg>
                    </div>
                </button>
                
                <button type="button" id="attachment-button" class="focus:outline-none" style="position: absolute; left: 5px; bottom: 13px; transform: none; background-color: transparent; border: none; cursor: pointer; z-index: 10;">
                    <div class="attachment-container" style="padding: 0.5rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-4 w-4" style="color: #666; transform: rotate(-45deg);">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                        </svg>
                        <span class="text-sm" style="color: #666;">Attach</span>
                    </div>
                    <div class="tooltip">
                        <span class="tooltip-text">Attach Files </span>
                    </div>
                </button>
                
                <button type="button" id="research-button" class="attachment-button focus:outline-none" style="position: absolute; left: 85px; bottom: 15px; transform: none; background-color: transparent; border: none; cursor: pointer; z-index: 10;" data-tooltip="Add Research">
                    <div class="attachment-container" style="display: flex; align-items: center; gap: 4px; padding: 6px 10px;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-4 w-4" style="color: #666;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span class="text-sm" style="color: #666;">Analyse</span>
                    </div>
                </button>
            </div>
            <div id="chat-container" class="chat-container"></div>
            <button id="scroll-to-bottom" class="scroll-to-bottom-button" aria-label="Scroll to bottom">
                <div class="custom-rounded" style="border: none;">
                    <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                                    
                </div>
            </button>
            <div id="suggested-queries" class="suggested-queries">
                <button class="query-chip" data-query="NVDA earnings">
                    NVDA earnings
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-4 w-4 text-gray-400">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                </button>
                <button class="query-chip" data-query="TSLA news today">
                    TSLA news today
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-4 w-4 text-gray-400">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                </button>
                <button class="query-chip" data-query="AAPL stock price">
                    AAPL stock price
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-4 w-4 text-gray-400">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                </button>
                <button class="query-chip" data-query="META forecast">
                    META forecast
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-4 w-4 text-gray-400">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                </button>
            </div>
        </section>
        <div id="footer-links" class="footer-container">
            <div class="footer-links">
                <a href="Blog.html" class="footer-link">Blog</a>
                <a href="pricing.html" class="footer-link">Pricing</a>
                <a href="terms.html" class="footer-link">Terms</a>
                <a href="privacy.html" class="footer-link">Privacy</a>
                <a href="contact.html" class="footer-link">Contact</a>
            </div>
        </div>
        <p id="disclaimer" class="disclaimer" style="display: none;">Votality may make mistakes. Please use with discretion.</p>
    </main>
</div>
<div id="feedback-popup" class="feedback-popup" style="display: none;">
    Thanks for your feedback!
</div>
<div id="feedback-modal" class="feedback-modal">
    <div class="feedback-modal-content">
        <div class="feedback-header">
            <h3>Tell us more:</h3>
            <button class="close-button" onclick="closeFeedbackModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="feedback-options">
            <button class="feedback-option">Shouldn't have used Memory</button>
            <button class="feedback-option">Don't like the style</button>
            <button class="feedback-option">Not factually correct</button>
            <button class="feedback-option">Refused when it shouldn't have</button>
        </div>
    </div>
</div>


<style>
.tooltip {
position: absolute;
left: 50%;
bottom: calc(100% + 12px);
transform: translateX(-50%);
background-color: black;
padding: 8px 12px;
border-radius: 6px;
font-size: 0.875rem;
white-space: nowrap;
opacity: 0;
pointer-events: none;
transition: opacity 0.1s ease;
z-index: 50;
display: none;
}

.tooltip:before {
content: '';
position: absolute;
left: 50%;
bottom: -6px;
transform: translateX(-50%);
border: 6px solid transparent;
border-top-color: black;
}

.tooltip-text {
color: white;
}

.tooltip-subtext {
color: rgba(255, 255, 255, 0.6);
}

#attachment-button:hover .tooltip {
opacity: 1;
display: block;
}

@media (max-width: 640px) {
.tooltip {
    display: none;
}
}

.custom-rounded {
border-radius: 8px;
border: 1px solid var(--border-color);
}

</style>
<script>
lucide.createIcons();
const textarea = document.getElementById('query-input');
const submitButton = document.getElementById('submit-button');
const initialContent = document.getElementById('initial-content');
const suggestedQueries = document.getElementById('suggested-queries');
const footerLinks = document.getElementById('footer-links');
const disclaimer = document.getElementById('disclaimer');
const textareaContainer = document.getElementById('textarea-container');
const chatContainer = document.getElementById('chat-container');
const attachmentButton = document.getElementById('attachment-button');
const desktopTopNav = document.querySelector('.desktop-top-nav');
const desktopTopNavTopic = document.querySelector('.desktop-top-nav__topic');
const chatTopicElement = document.getElementById('chat-topic');

let currentChatId = null;
let currentChatTopic = null;
let isUserLoggedIn = false;
let messageCount = 0;
let isInputLocked = false;
let cooldownEndTime = null;

const topNav = document.querySelector('.top-nav');
const topNavButtons = topNav.querySelector('.top-nav__buttons');

const staticText = "Ask Votality about "; // Original placeholder
const phrases = [
"the latest trends in...",
"analyzing in...",
"investment strategies for...",
"the impact of recent...",
"how to interpret...",
"renewable energy investments",
"effects of...",
"building an investment portfolio",
"quarterly earnings reports",
"technology in investing"
];
let currentPhraseIndex = 0;
let currentCharIndex = 0;
let isDeleting = false;
let typingAnimationActive = true; // Flag to control typing animation

function type() {
// Check if the textarea has text entered
if (!typingAnimationActive || textarea.value.trim() !== '') {
    textarea.placeholder = staticText; // Reset to default placeholder
    return; // Exit the function to stop the animation
}

const currentPhrase = phrases[currentPhraseIndex];

if (isDeleting) {
    // Remove a character from the dynamic part
    textarea.placeholder = staticText + currentPhrase.substring(0, currentCharIndex);
    currentCharIndex--;

    if (currentCharIndex < 0) {
        isDeleting = false; // Switch to typing mode
        currentPhraseIndex = (currentPhraseIndex + 1) % phrases.length; // Move to the next phrase
        currentCharIndex = 0; // Reset character index for the new phrase
    }
} else {
    // Add a character to the dynamic part
    textarea.placeholder = staticText + currentPhrase.substring(0, currentCharIndex);
    currentCharIndex++;

    if (currentCharIndex > currentPhrase.length) {
        isDeleting = true; // Switch to deleting mode after typing the full phrase
        setTimeout(type, 1000); // Wait before starting to delete
        return;
    }
}

setTimeout(type, isDeleting ? 30 : 70); // Adjust typing and deleting speed (faster)
}

// Start typing effect when the page loads
window.onload = function() {
type();
};

textarea.addEventListener('input', function() {
if (this.value.trim() !== '') {
    typingAnimationActive = false;
    textarea.placeholder = staticText;
    
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const customRounded = submitButton.querySelector('.custom-rounded');
    
    if (isDarkMode) {
        customRounded.classList.add('typing-active');
    } else {
        customRounded.classList.remove('typing-active');
        submitButton.querySelector('div').classList.remove('bg-gray-100');
        submitButton.querySelector('div').classList.add('bg-gray-800');
        submitButton.querySelector('svg').classList.remove('text-gray-300');
        submitButton.querySelector('svg').classList.add('text-white');
    }
} else {
    const customRounded = submitButton.querySelector('.custom-rounded');
    customRounded.classList.remove('typing-active');
    submitButton.querySelector('div').classList.add('bg-gray-100');
    submitButton.querySelector('div').classList.remove('bg-gray-800');
    submitButton.querySelector('svg').classList.add('text-gray-300');
    submitButton.querySelector('svg').classList.remove('text-white');
}

updateSignInButtonsVisibility();
});

// Add keydown event listener for Enter key handling
textarea.addEventListener('keydown', function(e) {
// Check if Enter was pressed without Shift key
if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault(); // Prevent new line
    
    const message = this.value.trim();
    console.log("User input:", message); // Log the user input

    if (message) {
        // Trigger the submit button's click event
        submitButton.click();
        console.log("Submit button clicked."); // Log when the submit button is clicked
        
        this.value = ''; // Clear the textarea after submission
        textarea.placeholder = "Ask Votality anything..."; // Change placeholder to submitText
        console.log("Placeholder changed to:", textarea.placeholder); // Log the new placeholder
    } else {
        console.log("No valid input to submit."); // Log if input is invalid
    }
}
});

function checkLoginStatus() {
    fetch('check_login_status.php')
        .then(response => response.json())
        .then(data => {
            isUserLoggedIn = data.isLoggedIn;
            
            const guestButtonsContainer = document.getElementById('guest-buttons-container');
            const accountContainer = document.getElementById('account-container');
            const tryProContainer = document.getElementById('try-pro-container');
            
            if (isUserLoggedIn) {
                // User is logged in
                if (guestButtonsContainer) {
                    guestButtonsContainer.style.display = 'none';
                }
                if (accountContainer) {
                    accountContainer.style.display = 'block';
                    // Update the sidebar account name
                    const sidebarName = accountContainer.querySelector('.user-name');
                    if (sidebarName && data.username) {
                        sidebarName.textContent = data.username;
                    }
                }
                if (tryProContainer) {
                    tryProContainer.style.display = 'block';
                }
                
                // Update top nav username
                const userFullnameElement = document.getElementById('user-fullname');
                if (userFullnameElement && data.username) {
                    userFullnameElement.textContent = data.username;
                }
            } else {
                // User is not logged in
                if (guestButtonsContainer) {
                    guestButtonsContainer.style.display = 'flex';
                }
                if (accountContainer) {
                    accountContainer.style.display = 'none';
                    // Reset sidebar name to Guest
                    const sidebarName = accountContainer.querySelector('.user-name');
                    if (sidebarName) {
                        sidebarName.textContent = 'Guest';
                    }
                }
                if (tryProContainer) {
                    tryProContainer.style.display = 'none';
                }
                
                // Reset top nav to Guest
                const userFullnameElement = document.getElementById('user-fullname');
                if (userFullnameElement) {
                    userFullnameElement.textContent = 'Guest';
                }
            }
            
            updateSignInButtonsVisibility();
        })
        .catch(error => console.error('Error checking login status:', error));
}
function updateSignInButtonsVisibility() {
if (window.innerWidth <= 640) {
    if (isUserLoggedIn || textarea.value.trim() !== '') {
        topNavButtons.style.display = 'none';
    } else {
        topNavButtons.style.display = 'flex';
    }
}
}

checkLoginStatus();

document.addEventListener('DOMContentLoaded', function() {
const accountContainer = document.querySelector('.account-container');
const accountPanel = document.getElementById('account-panel');
const sidebar = document.querySelector('.sidebar');

accountContainer.addEventListener('click', function(event) {
    event.stopPropagation();
    if (accountPanel.style.display === 'none' || accountPanel.style.display === '') {
        accountPanel.style.display = 'flex';
        positionAccountPanel();
    } else {
        accountPanel.style.display = 'none';
    }
});

document.addEventListener('click', function(event) {
    if (!accountPanel.contains(event.target) && event.target !== accountContainer) {
        accountPanel.style.display = 'none';
    }
});

function positionAccountPanel() {
    const rect = accountContainer.getBoundingClientRect();
    const sidebarWidth = sidebar.offsetWidth;
    accountPanel.style.bottom = `${window.innerHeight - rect.top}px`;
    accountPanel.style.left = `${sidebarWidth}px`;
}

// Call positionAccountPanel on window resize
window.addEventListener('resize', function() {
    if (accountPanel.style.display === 'flex') {
        positionAccountPanel();
    }
});

    // Update user info
    function updateUserInfo() {
    fetch('get_user_info.php')
        .then(response => response.json())
        .then(data => {
            if (userEmailElement) {
                userEmailElement.textContent = data.email;
            }
            if (userPlanElement) {
                userPlanElement.textContent = data.plan || 'Free Plan';
            }
        })
        .catch(error => console.error('Error fetching user info:', error));
}

updateUserInfo();

// Add event listeners for panel buttons
document.getElementById('billing-btn').addEventListener('click', function() {
    console.log('Billing clicked');
    // Implement billing functionality
});

document.getElementById('appearance-btn').addEventListener('click', function() {
    console.log('Appearance clicked');
    // Implement appearance settings functionality
});

document.getElementById('learn-more-btn').addEventListener('click', function() {
    console.log('Learn More clicked');
    // Implement learn more functionality
    });

    // Theme toggle
    const themeButtons = document.querySelectorAll('.theme-btn');
    themeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const theme = this.getAttribute('data-theme');
            console.log('Theme changed to:', theme);
            // Implement theme change functionality
        });
    });

    // Language select
    document.getElementById('language-select').addEventListener('change', function() {
        console.log('Language changed to:', this.value);
        // Implement language change functionality
    });

    // Upgrade plan
    document.getElementById('upgrade-plan-btn').addEventListener('click', function() {
        console.log('Upgrade Plan clicked');
        // Implement upgrade plan functionality
    });
});
    
// Your existing submit button code - keep this exactly as is
submitButton.addEventListener('click', async function() {
const message = textarea.value.trim();
if (message) {
// Hide initial content, suggested queries, and footer links
initialContent.classList.add('fade-out');
suggestedQueries.classList.add('fade-out');
footerLinks.classList.add('fade-out');

// Start repositioning textarea immediately
textareaContainer.classList.add('repositioned');

// Change background to white
document.body.classList.add('white-background');

// After the fade-out animation
setTimeout(async () => {
    initialContent.style.display = 'none';
    suggestedQueries.style.display = 'none';
    footerLinks.style.display = 'none';
   
    // Show chat container
    chatContainer.style.display = 'block';
    chatContainer.classList.add('fade-in');
   
    // Show disclaimer
    if (window.innerWidth > 640) {
        disclaimer.style.display = 'block';
        setTimeout(() => {
            disclaimer.classList.add('fade-in');
        }, 50);
    }
    
    // Show desktop top nav for larger screens
    if (window.innerWidth > 640) {
        const desktopTopNav = document.querySelector('.desktop-top-nav');
        desktopTopNav.style.display = 'flex';
        setTimeout(() => {
            desktopTopNav.classList.add('fade-in');
        }, 50);
    } else {
        // Hide top navigation for mobile when chat container appears
        const topNav = document.querySelector('.top-nav');
        if (topNav) {
            topNav.style.display = 'none';
        }
        // Add 'chat-active' class to body for mobile-specific styling
        document.body.classList.add('chat-active');
    }
   
    // Send message to AI and get response
    await sendMessage(message);
}, 500);
}
});

// Add this event listener to your new chat button
document.querySelector('.sidebar-button-container').addEventListener('click', function() {
// This will refresh the current page, effectively resetting everything to its initial state
window.location.reload();
});

function updateUsername() {
fetch('get_user_info.php')
    .then(response => response.json())
    .then(data => {
        const userFullnameElement = document.getElementById('user-fullname');
        if (userFullnameElement) {
            userFullnameElement.textContent = data.fullname;
        }
    })
    .catch(error => console.error('Error fetching user info:', error));
}

// Call this function when the page loads
document.addEventListener('DOMContentLoaded', updateUsername);          

// Add click event listener to the share button
document.querySelector('.desktop-top-nav__share-button').addEventListener('click', shareChatContent);

function updateChatTopicDisplay(topic) {
    const desktopTopNavTopic = document.querySelector('.desktop-top-nav__topic');
    if (!desktopTopNavTopic) return;

    // Clear existing content
    desktopTopNavTopic.innerHTML = '';

    if (!topic) {
        topic = 'New Chat';
    }

    // Clean up the topic text
    topic = topic.replace(/#/g, '').trim();
    
    // Remove "Related Topics" and everything after it
    const relatedTopicsIndex = topic.indexOf('Related Topics');
    if (relatedTopicsIndex !== -1) {
        topic = topic.substring(0, relatedTopicsIndex).trim();
    }

    // Limit the topic length
    if (topic.length > 50) {
        topic = topic.substring(0, 47) + '...';
    }

    // Split the topic into words for animation
    const words = topic.split(' ');
    
    words.forEach((word, index) => {
        const span = document.createElement('span');
        span.textContent = word + (index < words.length - 1 ? ' ' : '');
        span.style.opacity = '0';
        span.style.animation = `fadeIn 0.5s forwards ${index * 100}ms`;
        desktopTopNavTopic.appendChild(span);
    });

    // Ensure the desktop top nav is visible
    const desktopTopNav = document.querySelector('.desktop-top-nav');
    if (desktopTopNav && window.innerWidth > 640) {
        desktopTopNav.style.display = 'flex';
        desktopTopNav.classList.add('fade-in');
    }
}

async function shareChatContent() {
const chatContainer = document.getElementById('chat-container');
const chatTopic = document.getElementById('chat-topic').textContent;

// Extract text content
let chatContent = '';
chatContainer.querySelectorAll('.message').forEach(message => {
    chatContent += message.textContent + '\n\n';
});

// Generate a unique ID for this shared content
const sharedId = generateUniqueId();

try {
    // Save the shared content to the server
    await saveSharedContent(sharedId, chatContent, chatTopic);
    
    // Generate the shareable URL
    const shareUrl = `${window.location.origin}/shared-message.html?id=${sharedId}`;
    
    // Use the Web Share API if available, otherwise fallback to copying to clipboard
    if (navigator.share) {
        await navigator.share({
            title: 'Shared Votality Chat',
            text: 'Check out this Votality chat',
            url: shareUrl
        });
    } else {
        await navigator.clipboard.writeText(shareUrl);
        alert('Shareable link copied to clipboard!');
    }
} catch (error) {
    console.error('Error sharing content:', error);
    alert('An error occurred while sharing the content. Please try again.');
}
}

// Function to generate a unique ID
function generateUniqueId() {
return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// Function to save shared content to the server
async function saveSharedContent(id, content, topic) {
const response = await fetch('VotalityChat2.php', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify({
        action: 'saveSharedContent',
        id: id,
        content: content,
        topic: topic
    }),
});

if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
}

const result = await response.json();
if (result.error) {
    throw new Error(result.error);
}
}

// Get all required elements outside DOMContentLoaded
const sidebarToggle = document.querySelector('.sidebar-toggle');
const sidebar = document.querySelector('.sidebar');
const expandSidebarIcon = document.querySelector('.expand-sidebar-icon');

// Debug initial state
console.log('Initial elements found:', {
sidebarToggle,
sidebar,
expandSidebarIcon
});

// Function to handle collapse arrow click
function handleCollapseArrowClick() {
console.log('=== Collapse Arrow Click Debug ===');
console.log('Before collapse - Sidebar classes:', sidebar.classList.toString());

sidebar.classList.add('collapsed');
sidebar.classList.remove('expanded');
expandSidebarIcon.style.display = 'flex';

console.log('After collapse - Sidebar classes:', sidebar.classList.toString());
console.log('After collapse - Expand icon display:', expandSidebarIcon.style.display);
console.log('================================');
}

// Function to attach collapse arrow listener
function attachCollapseArrowListener() {
const collapseArrow = document.querySelector('.collapse-arrow');
console.log('Attempting to attach collapse listener to:', collapseArrow);

if (collapseArrow) {
    console.log('Found collapse arrow, attaching listener');
    // Remove any existing listeners first
    collapseArrow.removeEventListener('click', handleCollapseArrowClick);
    // Add new listener
    collapseArrow.addEventListener('click', handleCollapseArrowClick);
}
}

// Initial attachment
attachCollapseArrowListener();

// Watch for changes that might affect the collapse arrow
const observer = new MutationObserver((mutations) => {
console.log('DOM changed, checking collapse arrow');
attachCollapseArrowListener();
});

// Start observing
observer.observe(document.body, {
childList: true,
subtree: true
});

// Get the scroll to bottom button
const scrollToBottomButton = document.getElementById('scroll-to-bottom');

// Expand icon functionality
if (expandSidebarIcon) {
expandSidebarIcon.addEventListener('click', function() {
    console.log('=== Expand Icon Click Debug ===');
    console.log('Before expand - Sidebar classes:', sidebar.classList.toString());
    const topNavLeft = document.querySelector('.desktop-top-nav__left');
    console.log('Found topNavLeft:', topNavLeft); // Debug log

    sidebar.classList.remove('collapsed');
    sidebar.classList.add('expanded');
    expandSidebarIcon.style.display = 'none';

    if (topNavLeft) {
        console.log('Setting margin-left to 11.5rem'); // Debug log
        topNavLeft.style.marginLeft = '11.5rem';
        console.log('Current margin-left:', topNavLeft.style.marginLeft); // Debug log
    }

    // Move the scroll button
    if (scrollToBottomButton) {
        scrollToBottomButton.style.marginLeft = '15rem'; // Adjust margin when expanded
    }

    console.log('After expand - Sidebar classes:', sidebar.classList.toString());
    console.log('==============================');
});
}

// Sidebar toggle functionality
sidebarToggle.addEventListener('click', function() {
console.log('=== Sidebar Toggle Click Debug ===');
console.log('Before toggle - Sidebar classes:', sidebar.classList.toString());
const mainContent = document.querySelector('.main-content');
const desktopTopNav = document.querySelector('.desktop-top-nav');
const topNavLeft = document.querySelector('.desktop-top-nav__left'); // Get topNavLeft here

if (sidebar.classList.contains('collapsed')) {
    sidebar.classList.remove('collapsed');
    sidebar.classList.add('expanded');
    expandSidebarIcon.style.display = 'none';
    if (mainContent) mainContent.style.marginLeft = '15rem';
    if (desktopTopNav) {
        desktopTopNav.style.paddingLeft = '1rem'; // Decrease padding when sidebar expands
    }
    if (topNavLeft) {
        topNavLeft.style.marginLeft = '11.5rem'; // Set margin when expanded
    }
    // Move the scroll button
    if (scrollToBottomButton) {
        scrollToBottomButton.style.marginLeft = '15rem'; // Adjust margin when expanded
    }
} else {
    sidebar.classList.add('collapsed');
    sidebar.classList.remove('expanded');
    expandSidebarIcon.style.display = 'flex';
    if (mainContent) mainContent.style.marginLeft = '0';
    if (desktopTopNav) {
        desktopTopNav.style.paddingLeft = '2rem'; // Reset padding when sidebar collapses
    }
    if (topNavLeft) {
        topNavLeft.style.marginLeft = '0'; // Reset margin when collapsed
    }
    // Move the scroll button
    if (scrollToBottomButton) {
        scrollToBottomButton.style.marginLeft = '0'; // Reset margin when collapsed
    }
}

console.log('After toggle - Sidebar classes:', sidebar.classList.toString());
console.log('===============================');
});

// Add this to your existing JavaScript
document.addEventListener('DOMContentLoaded', function() {
const scrollButton = document.getElementById('scroll-to-bottom');
const chatContainer = document.querySelector('.chat-container');

if (chatContainer && scrollButton) {
    chatContainer.addEventListener('scroll', function() {
        // Show button if we're more than 100px from bottom
        const isNearBottom = this.scrollHeight - this.scrollTop - this.clientHeight < 100;
        
        if (!isNearBottom) {
            scrollButton.classList.add('visible');
        } else {
            scrollButton.classList.remove('visible');
        }
    });

    scrollButton.addEventListener('click', function() {
        chatContainer.scrollTo({
            top: chatContainer.scrollHeight,
            behavior: 'smooth'
        });
    });

    // Also show/hide button when new messages are added
    const observer = new MutationObserver(function() {
        const isNearBottom = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < 100;
        if (!isNearBottom) {
            scrollButton.classList.add('visible');
        }
    });

    observer.observe(chatContainer, {
        childList: true,
        subtree: true
    });
}
});

// Update sendMessage function to respect stay logged out choice
document.addEventListener('DOMContentLoaded', async () => {
const stayLoggedOut = sessionStorage.getItem('stayLoggedOut');

if (!stayLoggedOut) {
    try {
        const response = await fetch('/check_login_status.php');
        const data = await response.json();

        if (data.isLoggedIn) {
            isUserLoggedIn = true;
            if (data.username) {
                const userFullnameElement = document.getElementById('user-fullname');
                if (userFullnameElement) {
                    userFullnameElement.textContent = data.username;
                }
            }
            loadRecentChats();
        }
    } catch (error) {
        console.error('Auth check failed:', error);
    }
} else {
    // Set the username display to "Guest" for users who chose to stay logged out
    const userFullnameElement = document.getElementById('user-fullname');
    if (userFullnameElement) {
        userFullnameElement.textContent = 'Guest';
    }
}
updateSignInButtonsVisibility();
});
// Function to handle staying logged out
function handleStayLoggedOut() {
sessionStorage.setItem('stayLoggedOut', 'true');
window.location.href = 'index.html';
}

function addRelatedTopics(relatedTopics, chatGroup) {
// Remove existing related topics if any
const existingRelated = chatGroup.querySelector('.related-container');
if (existingRelated) {
    existingRelated.remove();
}

// Add Related heading
const relatedHeading = document.createElement('div');
relatedHeading.className = 'section-heading related-heading';
relatedHeading.textContent = 'Related';
chatGroup.appendChild(relatedHeading);

// Add related content
const relatedContainer = document.createElement('div');
relatedContainer.className = 'related-container';

relatedTopics.forEach(topic => {
    const relatedItem = document.createElement('div');
    relatedItem.className = 'related-item';

    const textSpan = document.createElement('span');
    textSpan.className = 'related-item-text';
    textSpan.textContent = topic;

    const iconSpan = document.createElement('span');
    iconSpan.className = 'related-item-icon';
    iconSpan.innerHTML = '<i data-lucide="plus"></i>';

    relatedItem.appendChild(textSpan);
    relatedItem.appendChild(iconSpan);
    relatedContainer.appendChild(relatedItem);
});

chatGroup.appendChild(relatedContainer);

// Initialize Lucide icons for the new elements
lucide.createIcons();

console.log("Related topics added:", relatedTopics);
}

function sendRelatedTopic(topic) {
console.log("Sending related topic as message:", topic);

// Clear the textarea if it has any existing content
textarea.value = '';

// Set the textarea value to the clicked topic
textarea.value = topic;

// Trigger the send button click event
submitButton.click();
}

// Add this check when the page loads
document.addEventListener('DOMContentLoaded', async () => {
try {
    const response = await fetch('VotalityChat2.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'checkMessageLimits'
        }),
    });

    const data = await response.json();
    
    if (data.error === 'cooldown') {
        textarea.disabled = true;
        submitButton.disabled = true;
        startCooldownTimer(data.remainingTime);
    }
} catch (error) {
    console.error('Error checking message limits:', error);
}
});

// Update the sendMessage function in your JavaScript
async function sendMessage(message, file = null) {
    try {
        // Do the UI transitions first
        initialContent.classList.add('fade-out');
        suggestedQueries.classList.add('fade-out');
        footerLinks.classList.add('fade-out');
        textareaContainer.classList.add('repositioned');
        document.body.classList.add('white-background');
        
        setTimeout(async () => {
            // Hide initial elements
            initialContent.style.display = 'none';
            suggestedQueries.style.display = 'none';
            footerLinks.style.display = 'none';
            chatContainer.style.display = 'block';
            chatContainer.classList.add('fade-in');

            // Handle desktop/mobile specific UI
            if (window.innerWidth > 640) {
                disclaimer.style.display = 'block';
                setTimeout(() => {
                    disclaimer.classList.add('fade-in');
                }, 50);
                
                desktopTopNav.style.display = 'flex';
                setTimeout(() => {
                    desktopTopNav.classList.add('fade-in');
                }, 50);
            } else {
                const topNav = document.querySelector('.top-nav');
                if (topNav) {
                    topNav.style.display = 'none';
                }
                document.body.classList.add('chat-active');
            }

            // Add user message and show thinking indicator
            const userMessageElement = await addMessage(message, 'user');
            textarea.value = '';
            
            // Get the function to signal AI response readiness
            const signalAIResponse = showAIThinking();
            
            if (userMessageElement) {
                userMessageElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            try {
                // Extract potential stock symbols (looking for $SYMBOL or standalone uppercase letters)
                const stockSymbolMatch = message.match(/\$([A-Z]{1,5})|(?:^|\s)([A-Z]{1,5})(?:\s|$)/);
                let marketData = null;
                let tavilyData = null;
                
                // If we found a stock symbol, fetch market data
                if (stockSymbolMatch) {
                    const symbol = stockSymbolMatch[1] || stockSymbolMatch[2];
                    
                    // Fetch market data and Tavily search results in parallel
                    [marketData, tavilyData] = await Promise.all([
                        fetchMarketData(symbol),
                        performTavilySearch(symbol)
                    ]);
                }

                const stayLoggedOut = sessionStorage.getItem('stayLoggedOut') === 'true';
                const response = await fetch('VotalityChat2.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'sendMessage',
                        message: message,
                        chatId: currentChatId,
                        stayLoggedOut: stayLoggedOut,
                        file: file ? { data: await readFileAsDataURL(file), type: file.type } : null,
                        marketData: marketData ? {
                            currentPrice: marketData.c,
                            highPrice: marketData.h,
                            lowPrice: marketData.l,
                            openPrice: marketData.o,
                            previousClose: marketData.pc,
                            timestamp: new Date().toISOString()
                        } : null,
                        additionalInfo: tavilyData ? {
                            summary: tavilyData.answer,
                            sources: tavilyData.results
                        } : null
                    }),
                    credentials: 'same-origin'
                });

                const data = await response.json();

                // Handle authentication errors
                if (data.error) {
                    if (data.error === 'auth_required' && !stayLoggedOut) {
                        signalAIResponse();
                        sessionStorage.setItem('returnUrl', window.location.href);
                        window.location.href = '/signin.html';
                        return;
                    }
                    if (data.error === 'auth_required' && stayLoggedOut) {
                        // Ignore auth error if user chose to stay logged out
                    } else {
                        throw new Error(data.error);
                    }
                }

                // Update chat topic if provided
                if (data.chatTopic) {
                    updateChatTopicDisplay(data.chatTopic);
                }

// Wait briefly for checkpoints to complete
setTimeout(async () => {
    // Signal AI response right before adding the message
    signalAIResponse();
    
    // Add AI response
    await addMessage(data.response, 'ai', data.relatedTopics);

                    // Handle market data if present
                    if (data.marketData) {
                        const marketSection = createMarketDataSection(data.marketData);
                        const aiMessage = document.querySelector('.message.ai:last-child');
                        if (aiMessage) {
                            aiMessage.insertBefore(marketSection, aiMessage.firstChild);
                        }
                    }

                    // Set chat ID if not already set
                    if (!currentChatId) {
                        currentChatId = data.chatId;
                    }

                    // Load recent chats after successful message
                    await loadRecentChats();
                }, 800);

            } catch (error) {
                console.error('Error:', error);
                signalAIResponse();
                await addMessage("I'm sorry, there was an error processing your request: " + error.message, 'ai');
            }
        }, 500);

    } catch (error) {
        console.error('Error in sendMessage:', error);
        await addMessage("Error: " + error.message, 'ai');
    }
}

// Update DOM content loaded handler
document.addEventListener('DOMContentLoaded', async () => {
const stayLoggedOut = sessionStorage.getItem('stayLoggedOut') === 'true';

if (!stayLoggedOut) {
    try {
        const response = await fetch('/check_login_status.php');
        const data = await response.json();

        if (data.isLoggedIn) {
            isUserLoggedIn = true;
            const userFullnameElement = document.getElementById('user-fullname');
            if (userFullnameElement && data.username) {
                userFullnameElement.textContent = data.username;
            }
            loadRecentChats();
        }
    } catch (error) {
        console.error('Auth check failed:', error);
    }
} else {
    // Set the username display to "Guest" for users who chose to stay logged out
    const userFullnameElement = document.getElementById('user-fullname');
    if (userFullnameElement) {
        userFullnameElement.textContent = 'Guest';
    }
}
updateSignInButtonsVisibility();
});


function formatCooldownTime(seconds) {
const hours = Math.floor(seconds / 3600);
const minutes = Math.floor((seconds % 3600) / 60);
return `
    <div class="font-semibold text-gray-700">
        Time remaining: ${hours}h ${minutes}m
    </div>
`;
}

// Update the cooldown timer function
function startCooldownTimer() {
if (cooldownEndTime) {
    const timerInterval = setInterval(() => {
        const remainingTime = cooldownEndTime - Date.now();
        
        if (remainingTime <= 0) {
            clearInterval(timerInterval);
            updateInputContainer(false);
        } else {
            updateInputContainer(true, Math.floor(remainingTime / 1000));
        }
    }, 1000);
}
}

// Add this to your main JavaScript file
function initializeAccountPanel() {
const accountPanel = document.getElementById('account-panel');
const userEmailElement = document.getElementById('user-email');
const userPlanElement = document.getElementById('user-plan');
const upgradeButton = accountPanel.querySelector('.account-panel-footer');
const logoutButton = accountPanel.querySelector('.panel-button-content:last-child');

// Load account info
fetch('/account_handler.php', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: 'action=get_account_info'
})
.then(response => response.json())
.then(data => {
    if (data.error) {
        console.error(data.error);
        return;
    }
    userEmailElement.textContent = data.email;
    userPlanElement.textContent = data.planDisplay;
})
.catch(error => console.error('Error:', error));

// Handle logout
logoutButton.addEventListener('click', () => {
    fetch('/account_handler.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'action=logout'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.redirect;
        }
    })
    .catch(error => console.error('Error:', error));
});

// Handle upgrade plan
upgradeButton.addEventListener('click', () => {
    window.location.href = 'pricing.html';
});
}

// Call this when the page loads
document.addEventListener('DOMContentLoaded', initializeAccountPanel);

// Helper function to detect dark mode
function isDarkMode() {
return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
}

// Helper function to create file source element
function createFileSource(file) {
const fileSource = document.createElement('div');
fileSource.style.display = 'flex';
fileSource.style.alignItems = 'center';
fileSource.style.backgroundColor = isDarkMode() ? '#232323' : '#f3f4f6';
fileSource.style.borderRadius = '8px';
fileSource.style.padding = '8px 12px';
fileSource.style.width = '200px';
fileSource.style.flexShrink = '0';
fileSource.style.cursor = 'pointer';
fileSource.style.transition = 'background-color 0.2s ease';
fileSource.style.position = 'relative';

fileSource.addEventListener('mouseover', () => {
    fileSource.style.backgroundColor = isDarkMode() ? '#2a2d33' : '#e5e7eb';
});

fileSource.addEventListener('mouseout', () => {
    fileSource.style.backgroundColor = isDarkMode() ? '#232323' : '#f3f4f6';
});

const fileIcon = document.createElement('div');
fileIcon.style.width = '24px';
fileIcon.style.height = '24px';
fileIcon.style.flexShrink = '0';
fileIcon.style.marginRight = '4px';
fileIcon.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-5 w-5 text-gray-600">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
    </svg>
`;

const fileName = document.createElement('span');
fileName.style.fontSize = '0.875rem';
fileName.style.color = isDarkMode() ? '#ffffff' : '#374151';
fileName.style.whiteSpace = 'nowrap';
fileName.style.overflow = 'hidden';
fileName.style.textOverflow = 'ellipsis';
fileName.style.flex = '1';
fileName.style.marginLeft = '2px';
fileName.style.paddingRight = '8px';
fileName.style.textAlign = 'left';
fileName.textContent = file.name;

fileSource.appendChild(fileIcon);
fileSource.appendChild(fileName);
return fileSource;
}

// Helper function to create source item element
function createSourceItem(source) {
    const sourceItem = document.createElement('div');
    sourceItem.style.display = 'flex';
    sourceItem.style.flexDirection = 'column';
    sourceItem.style.backgroundColor = isDarkMode() ? '#232323' : '#f3f4f6';
    sourceItem.style.borderRadius = '6px';
    sourceItem.style.padding = '8px 12px';
    sourceItem.style.width = '190px'; // Increased width to accommodate the link icon
    sourceItem.style.flexShrink = '0';
    sourceItem.style.cursor = 'pointer';
    sourceItem.style.transition = 'background-color 0.2s ease';
    sourceItem.style.position = 'relative';

    sourceItem.addEventListener('mouseover', () => {
        sourceItem.style.backgroundColor = isDarkMode() ? '#2a2d33' : '#e5e7eb';
    });
    sourceItem.addEventListener('mouseout', () => {
        sourceItem.style.backgroundColor = isDarkMode() ? '#232323' : '#f3f4f6';
    });

    // Container for title and link icon
    const titleContainer = document.createElement('div');
    titleContainer.style.display = 'flex';
    titleContainer.style.justifyContent = 'space-between';
    titleContainer.style.alignItems = 'center';
    titleContainer.style.width = '100%';
    titleContainer.style.marginBottom = '2px';

    // Create title element
    const titleElement = document.createElement('div');
    titleElement.style.fontSize = '0.875rem';
    titleElement.style.color = isDarkMode() ? '#ffffff' : '#374151';
    titleElement.style.whiteSpace = 'nowrap';
    titleElement.style.overflow = 'hidden';
    titleElement.style.textOverflow = 'ellipsis';
    titleElement.style.flex = '1';
    titleElement.textContent = source.name;

    // Create link icon
    const linkIcon = document.createElement('span');
    linkIcon.innerHTML = '<i data-lucide="external-link" class="w-3 h-3"></i>';
    linkIcon.style.marginLeft = '8px';
    linkIcon.style.color = isDarkMode() ? '#9CA3AF' : '#6B7280';

    titleContainer.appendChild(titleElement);
    titleContainer.appendChild(linkIcon);

    // Create metric element
    const metricElement = document.createElement('div');
    metricElement.style.fontSize = '0.75rem';
    metricElement.style.color = isDarkMode() ? '#9CA3AF' : '#6B7280';
    metricElement.style.whiteSpace = 'nowrap';
    metricElement.style.display = 'flex';
    metricElement.style.alignItems = 'center';
    metricElement.style.gap = '4px';
    
    const metricText = document.createElement('span');
    metricText.textContent = source.metric;
    
    // Create copy icon
    const copyIcon = document.createElement('span');
    copyIcon.innerHTML = '<i data-lucide="copy" class="w-3 h-3"></i>';
    
    metricElement.appendChild(metricText);
    metricElement.appendChild(copyIcon);

    sourceItem.appendChild(titleContainer);
    sourceItem.appendChild(metricElement);
    
    return sourceItem;
}
// Add event listener for system dark mode changes
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
const fileSourceElements = document.querySelectorAll('.file-source');
const sourceItemElements = document.querySelectorAll('.source-item');

const backgroundColor = e.matches ? '#232323' : '#f3f4f6';
const textColor = e.matches ? '#ffffff' : '#374151';

fileSourceElements.forEach(el => {
    el.style.backgroundColor = backgroundColor;
    el.querySelector('span').style.color = textColor;
});

sourceItemElements.forEach(el => {
    el.style.backgroundColor = backgroundColor;
    el.querySelector('span').style.color = textColor;
});
});
function initializeAccountFunctionality() {
const accountPanel = document.getElementById('account-panel');

// Learn More button
document.getElementById('learn-more-btn').addEventListener('click', () => {
    window.location.href = 'Blog.html';
});

// Help & Support button
document.getElementById('help-support-btn').addEventListener('click', () => {
    window.location.href = 'contact.html';
});

// Logout button
document.getElementById('logout-btn').addEventListener('click', async () => {
    try {
        const response = await fetch('account_handler.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'action=logout'
        });

        const data = await response.json();
        if (data.success) {
            window.location.href = 'signin.html';
        }
    } catch (error) {
        console.error('Logout error:', error);
    }
});

// Upgrade Plan button
const upgradeButton = document.querySelector('#upgrade-plan-btn');
if (upgradeButton) {
    upgradeButton.addEventListener('click', () => {
        window.location.href = 'pricing.html';
    });
}
}

// Initialize account functionality when the document loads
document.addEventListener('DOMContentLoaded', initializeAccountFunctionality);

function generateHeading(paragraph) {
// Try to extract explicit heading from [Heading]: format
const headingMatch = paragraph.match(/^\[([^\]]+)\]:/);
if (headingMatch) {
    return headingMatch[1].trim();
}

// Define content analysis patterns and their corresponding headings
const contentPatterns = [
    {
        patterns: ['market cap', 'valuation', 'worth', 'valued at', 'billion', 'million'],
        heading: 'Market Valuation'
    },
    {
        patterns: ['stock price', 'shares', 'trading at', 'stock market', 'equity'],
        heading: 'Stock Performance'
    },
    {
        patterns: ['revenue', 'earnings', 'profit', 'income', 'financial results'],
        heading: 'Financial Results'
    },
    {
        patterns: ['forecast', 'predict', 'expect', 'outlook', 'future'],
        heading: 'Future Outlook'
    },
    {
        patterns: ['risk', 'challenge', 'concern', 'warning', 'caution'],
        heading: 'Risk Assessment'
    },
    {
        patterns: ['opportunity', 'potential', 'growth', 'expand', 'development'],
        heading: 'Growth Opportunities'
    },
    {
        patterns: ['industry', 'sector', 'market segment', 'competition'],
        heading: 'Industry Analysis'
    },
    {
        patterns: ['technolog', 'innovation', 'develop', 'research'],
        heading: 'Technology & Innovation'
    },
    {
        patterns: ['management', 'executive', 'leadership', 'strategy'],
        heading: 'Management Strategy'
    },
    {
        patterns: ['acquisition', 'merger', 'partnership', 'deal'],
        heading: 'Corporate Development'
    },
    {
        patterns: ['regulation', 'law', 'compliance', 'legal'],
        heading: 'Regulatory Impact'
    },
    {
        patterns: ['global', 'international', 'worldwide', 'region'],
        heading: 'Global Perspective'
    },
    {
        patterns: ['trend', 'pattern', 'movement', 'direction'],
        heading: 'Market Trends'
    },
    {
        patterns: ['compare', 'versus', 'competition', 'competitor'],
        heading: 'Competitive Analysis'
    },
    {
        patterns: ['economic', 'economy', 'gdp', 'inflation'],
        heading: 'Economic Context'
    },
    {
        patterns: ['invest', 'portfolio', 'asset', 'allocation'],
        heading: 'Investment Analysis'
    },
    {
        patterns: ['dividend', 'yield', 'payout', 'distribution'],
        heading: 'Dividend Analysis'
    },
    {
        patterns: ['trade', 'volume', 'liquidity', 'exchange'],
        heading: 'Trading Activity'
    },
    {
        patterns: ['policy', 'government', 'fed', 'central bank'],
        heading: 'Policy Impact'
    },
    {
        patterns: ['summary', 'conclude', 'overall', 'takeaway'],
        heading: 'Key Takeaways'
    }
];

// Convert paragraph to lowercase for pattern matching
const lowerParagraph = paragraph.toLowerCase();

// Check for pattern matches
for (const {patterns, heading} of contentPatterns) {
    if (patterns.some(pattern => lowerParagraph.includes(pattern))) {
        return heading;
    }
}

// Analyze paragraph structure for special cases
if (paragraph.includes('%') && /\d+(\.\d+)?%/.test(paragraph)) {
    return 'Statistical Analysis';
}
if (/\$\d+|\d+ dollars/i.test(paragraph)) {
    return 'Financial Metrics';
}
if (paragraph.split('.').length > 3) {
    return 'Detailed Analysis';
}
if (paragraph.length < 100) {
    return 'Quick Overview';
}

// Contextual analysis for time references
if (/yesterday|today|tomorrow|week|month|year|quarter/i.test(paragraph)) {
    return 'Temporal Analysis';
}

// Default headings for opening and closing paragraphs
if (paragraph === firstParagraphInMessage) {
    return 'Market Overview';
}
if (paragraph === lastParagraphInMessage) {
    return 'Concluding Analysis';
}

// Fallback heading
return 'Market Analysis';
}

    function fadeOutLoadingSequence() {
            const loadingContainer = lastChatGroup.querySelector('.loading-container');
            if (loadingContainer) {
                // Instead of fading out and removing, we just collapse it
                loadingContainer.classList.add('collapsed');
                // Ensure the dropdown button is in the correct state
                const dropdownBtn = loadingContainer.querySelector('.loading-dropdown-btn');
                if (dropdownBtn) {
                    dropdownBtn.classList.add('rotated');
                }
            }
        }
        
        function showAIThinking() {
        const chatContainer = document.querySelector('.chat-container');
        const lastChatGroup = chatContainer.lastElementChild;
        let isAIResponseReady = false;

        // Create the loading sequence container
        const loadingContainer = document.createElement('div');
        loadingContainer.className = 'loading-container';

        // Create and add the container header
        const containerHeader = document.createElement('div');
        containerHeader.className = 'loading-container-header';

        // Create the header right section
        const headerRight = document.createElement('div');
        headerRight.className = 'header-right hidden';
        headerRight.innerHTML = `
            <span class="source-count">9 sources</span>
            <button class="loading-dropdown-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m6 9 6 6 6-6"/>
                </svg>
            </button>
        `;

        containerHeader.innerHTML = `
            <div class="loading-container-title">Search</div>
        `;
        containerHeader.appendChild(headerRight);
        loadingContainer.appendChild(containerHeader);

        // Create checkpoints list container
        const checkpointsList = document.createElement('div');
        checkpointsList.id = 'checkpoints-list';
        loadingContainer.appendChild(checkpointsList);

        // Add dropdown functionality for the main container
        const dropdownBtn = containerHeader.querySelector('.loading-dropdown-btn');
        dropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            dropdownBtn.classList.toggle('rotated');
            loadingContainer.classList.toggle('collapsed');
        });

        // Add to chat container
        lastChatGroup.insertBefore(loadingContainer, lastChatGroup.firstChild.nextSibling);

        const steps = [
            {
                title: "Searching financial databases",
                detail: "Initiating market data retrieval from global sources"
            },
            {
                title: "Analyzing Annual & Interim Reports",
                detail: "Processing 16 quarters of financial statements"
            },
            {
                title: "Reviewing News Releases",
                detail: "Analyzing 342 recent company announcements"
            },
            {
                title: "Processing SEC Filings",
                detail: "Examining 53K words of regulatory documents"
            },
            {
                title: "Scanning Corporate Governance",
                detail: "Reviewing 18 organizational documents"
            },
            {
                title: "Preparing comprehensive analysis",
                detail: "Synthesizing market data insights"
            }
        ];

        let currentStep = 0;
        let activeCheckpoint = null;
        let nextPendingCheckpoint = null;
        let sequenceTimeout = null;
        let completedSteps = new Set();  // Add this at the top with other state variables

        function addCheckpoint(step, type = 'pending') {
    // First check if we've already processed this step
    if (completedSteps.has(step)) {
        console.warn(`Attempted to add duplicate checkpoint for step ${step}`);
        return null;
    }

    const checkpoint = createCheckpoint(steps[step]);
    checkpoint.style.opacity = '0';
    checkpoint.style.transform = 'translateY(20px)';
    checkpointsList.appendChild(checkpoint);

    // Force a reflow to ensure the initial styles are applied
    checkpoint.offsetHeight;

    // Add visible class and transition in
    requestAnimationFrame(() => {
        checkpoint.style.opacity = '1';
        checkpoint.style.transform = 'translateY(0)';
        checkpoint.classList.add('visible');
        const checkpointElement = checkpoint.querySelector('.checkpoint');
        checkpointElement.classList.add(type);
        
        if (type === 'active') {
            activeCheckpoint = checkpointElement;
        } else if (type === 'pending') {
            nextPendingCheckpoint = checkpointElement;
        }
    });

    // Track that we've created this checkpoint
    completedSteps.add(step);

    return checkpoint.querySelector('.checkpoint');
}

        function startSequence() {
            // Add first active checkpoint
            addCheckpoint(currentStep++, 'active');
            
            // Add first pending checkpoint
            if (currentStep < steps.length) {
                addCheckpoint(currentStep, 'pending');
            }

            // Start the progression sequence
            scheduleNextProgression();
        }

        function scheduleNextProgression() {
            if (!isAIResponseReady && currentStep < steps.length) {
                sequenceTimeout = setTimeout(progressSequence, 1500);
            }
        }

        function progressSequence() {
    if (isAIResponseReady || currentStep >= steps.length) return;

    // Complete current active checkpoint
    if (activeCheckpoint) {
        activeCheckpoint.classList.remove('active');
        activeCheckpoint.classList.add('completed');
        addTickToCheckpoint(activeCheckpoint);
        addDropdownToCheckpoint(activeCheckpoint);
        activeCheckpoint = null;
    }

    // Make pending checkpoint active
    if (nextPendingCheckpoint) {
        nextPendingCheckpoint.classList.remove('pending');
        nextPendingCheckpoint.classList.add('active');
        activeCheckpoint = nextPendingCheckpoint;
        nextPendingCheckpoint = null;
    }

    // Add new pending checkpoint if available and not already added
    if (currentStep < steps.length - 1 && !completedSteps.has(currentStep + 1)) {
        addCheckpoint(currentStep + 1, 'pending');
    }

    currentStep++;
    scheduleNextProgression();
}

        function completeRemainingCheckpoints() {
        clearTimeout(sequenceTimeout);
        let delay = 0;

        // Complete active checkpoint if exists
        if (activeCheckpoint) {
            setTimeout(() => {
                activeCheckpoint.classList.remove('active');
                activeCheckpoint.classList.add('completed');
                addTickToCheckpoint(activeCheckpoint);
                addDropdownToCheckpoint(activeCheckpoint);
                activeCheckpoint = null;
            }, delay);
            delay += 200;
        }

        // Complete pending checkpoint if exists
        if (nextPendingCheckpoint) {
            setTimeout(() => {
                nextPendingCheckpoint.classList.remove('pending');
                nextPendingCheckpoint.classList.add('completed');
                addTickToCheckpoint(nextPendingCheckpoint);
                addDropdownToCheckpoint(nextPendingCheckpoint);
                nextPendingCheckpoint = null;
            }, delay);
            delay += 200;
        }

        // Add and complete remaining checkpoints
        for (let i = currentStep; i < steps.length; i++) {
            ((index) => {
                setTimeout(() => {
                    const checkpoint = addCheckpoint(index, 'pending');
                    setTimeout(() => {
                        checkpoint.classList.remove('pending');
                        checkpoint.classList.add('completed');
                        addTickToCheckpoint(checkpoint);
                        addDropdownToCheckpoint(checkpoint);
                    }, 100);
                }, delay);
            })(i);
            delay += 200;
        }

            // Show header elements and collapse
            setTimeout(() => {
                headerRight.classList.remove('hidden');
                headerRight.classList.add('fade-in');
                setTimeout(() => {
                    fadeOutLoadingSequence(loadingContainer);
                }, 300);
            }, delay + 200);
        }

        function signalAIResponse() {
            isAIResponseReady = true;
            completeRemainingCheckpoints();
        }

        // Start the sequence
        startSequence();
        lastChatGroup.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Return the signal function
        return signalAIResponse;
    }

    function createCheckpoint(stepData) {
    const checkpointContainer = document.createElement('div');
    checkpointContainer.className = 'checkpoint-container';

    const checkpoint = document.createElement('div');
    checkpoint.className = 'checkpoint';

    // Create empty circle without tick
    const circle = document.createElement('div');
    circle.className = 'checkpoint-circle';
    // No SVG here anymore - it will be added only when completed

    const content = document.createElement('div');
    content.className = 'checkpoint-content';

    const header = document.createElement('div');
    header.className = 'checkpoint-header';

    const title = document.createElement('div');
    title.className = 'checkpoint-title';
    title.textContent = stepData.title;

    header.appendChild(title);

    const detail = document.createElement('div');
    detail.className = 'checkpoint-detail';
    detail.textContent = stepData.detail;

    content.appendChild(header);
    content.appendChild(detail);

    checkpoint.appendChild(circle);
    checkpoint.appendChild(content);

    checkpointContainer.appendChild(checkpoint);

    return checkpointContainer;
}
    function addDropdownToCheckpoint(checkpoint) {
        const header = checkpoint.querySelector('.checkpoint-header');
        
        const dropdownBtn = document.createElement('button');
        dropdownBtn.className = 'checkpoint-dropdown-btn';
        dropdownBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m6 9 6 6 6-6"/>
            </svg>
        `;

        const detailSection = checkpoint.querySelector('.checkpoint-detail');
        
        dropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            dropdownBtn.classList.toggle('rotated');
            detailSection.classList.toggle('show');
        });

        header.appendChild(dropdownBtn);
    }

    function fadeOutLoadingSequence(loadingContainer) {
        if (loadingContainer) {
            loadingContainer.classList.add('transitioning');
            loadingContainer.classList.add('collapsed');
            
            const dropdownBtn = loadingContainer.querySelector('.loading-dropdown-btn');
            if (dropdownBtn) {
                dropdownBtn.classList.add('rotated');
            }

            setTimeout(() => {
                loadingContainer.classList.remove('transitioning');
            }, 300);
        }
    }
    // Add this new function to handle adding the tick
    function addTickToCheckpoint(checkpoint) {
        const circle = checkpoint.querySelector('.checkpoint-circle');
        circle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><polyline points="20 6 9 17 4 12"/></svg>`;
    }

    function addDropdownToCheckpoint(checkpoint) {
        // Get the checkpoint header
        const header = checkpoint.querySelector('.checkpoint-header');
        
        // Create dropdown button
        const dropdownBtn = document.createElement('button');
        dropdownBtn.className = 'checkpoint-dropdown-btn';
        dropdownBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m6 9 6 6 6-6"/>
            </svg>
        `;

        // Get the detail section
        const detailSection = checkpoint.querySelector('.checkpoint-detail');
        
        // Add click handler for the dropdown
        dropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            dropdownBtn.classList.toggle('rotated');
            detailSection.classList.toggle('show');
        });

        // Add the dropdown button to the header
        header.appendChild(dropdownBtn);
    }

    function hideAIThinking() {
        const chatContainer = document.querySelector('.chat-container');
        const lastChatGroup = chatContainer.lastElementChild;
        
        const loadingContainer = lastChatGroup.querySelector('.loading-container');
        if (loadingContainer) {
            loadingContainer.remove();
        }
    }

function toggleMobileNav() {
const bottomNav = document.querySelector('.bottom-nav');
const sidebar = document.querySelector('.sidebar');
const mainContent = document.querySelector('.main-content');

if (window.innerWidth <= 640) {
    topNav.style.display = 'flex';
    bottomNav.style.display = 'flex';
    sidebar.style.display = 'none';
    desktopTopNav.style.display = 'none';
    mainContent.style.paddingTop = '60px';
    mainContent.style.paddingBottom = '60px';

    // Update signin/signup buttons visibility
    updateSignInButtonsVisibility();
} else {
    topNav.style.display = 'none';
    bottomNav.style.display = 'flex';
    sidebar.style.display = 'flex';
    // Only show desktop top nav if it's already visible (after submit)
    if (desktopTopNav.classList.contains('fade-in')) {
        desktopTopNav.style.display = 'flex';
    }
    mainContent.style.paddingTop = '0';
    mainContent.style.paddingBottom = '0';
}
}

// Add event listener for window resize
window.addEventListener('resize', toggleMobileNav);

function updateChatListUI(chats) {
    const chatList = document.querySelector('.chat-list');
    if (!chatList) return;

    // Clear existing chats
    chatList.innerHTML = '';

    if (!chats || chats.length === 0) {
        chatList.innerHTML = `
            <div class="chat-item no-chats" style="background: transparent !important;">
                <span class="chat-name">No recent chats</span>
            </div>
        `;
        return;
    }

    chats.forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        // Adding transparent background as important
        chatItem.style.cssText = 'background: transparent !important;';
        
        if (chat.chat_id === currentChatId) {
            chatItem.classList.add('active');
        }

        const topicSpan = document.createElement('span');
        topicSpan.className = 'chat-name';
        topicSpan.textContent = chat.topic || 'New Chat';

        const previewSpan = document.createElement('span');
        previewSpan.className = 'chat-preview';
        previewSpan.textContent = chat.preview || '';

        chatItem.appendChild(topicSpan);
        if (chat.preview) {
            chatItem.appendChild(previewSpan);
        }

        chatItem.addEventListener('click', async () => {
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            chatItem.classList.add('active');
            currentChatId = chat.chat_id;
            updateChatTopicDisplay(chat.topic);
            await loadChat(chat.chat_id);
        });

        chatList.appendChild(chatItem);
    });
}

async function loadRecentChats() {
    try {
        const response = await fetch('VotalityChat2.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'getRecentChats'
            }),
            credentials: 'same-origin'
        });

        const data = await response.json();
        console.log('Recent chats data:', data);

        const chatList = document.querySelector('.chat-list');
        if (!chatList) return;

        chatList.innerHTML = '';

        if (!data.chats || data.chats.length === 0) {
            chatList.innerHTML = `
                <div class="chat-item" style="background: transparent !important;">
                    <span class="chat-name">No recent chats</span>
                </div>
            `;
            return;
        }

        data.chats.forEach(chat => {
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            // Adding transparent background as important
            chatItem.style.cssText = 'background: transparent !important;';
            chatItem.innerHTML = `<span class="chat-name">${chat.topic || 'New Chat'}</span>`;
            
            chatItem.addEventListener('click', async () => {
                try {
                    initialContent.classList.add('fade-out');
                    suggestedQueries.classList.add('fade-out');
                    footerLinks.classList.add('fade-out');
                    textareaContainer.classList.add('repositioned');
                    document.body.classList.add('white-background');

                    setTimeout(async () => {
                        initialContent.style.display = 'none';
                        suggestedQueries.style.display = 'none';
                        footerLinks.style.display = 'none';
                        chatContainer.style.display = 'block';
                        chatContainer.classList.add('fade-in');

                        if (window.innerWidth > 640) {
                            disclaimer.style.display = 'block';
                            setTimeout(() => {
                                disclaimer.classList.add('fade-in');
                            }, 50);
                        }

                        if (window.innerWidth > 640) {
                            desktopTopNav.style.display = 'flex';
                            setTimeout(() => {
                                desktopTopNav.classList.add('fade-in');
                            }, 50);
                        } else {
                            const topNav = document.querySelector('.top-nav');
                            if (topNav) {
                                topNav.style.display = 'none';
                            }
                            document.body.classList.add('chat-active');
                        }

                        chatContainer.innerHTML = '';

                        const messagesResponse = await fetch('VotalityChat2.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                action: 'loadChat',
                                chatId: chat.chat_id
                            }),
                            credentials: 'same-origin'
                        });

                        const messagesData = await messagesResponse.json();
                        console.log('Chat messages:', messagesData);

                        updateChatTopicDisplay(chat.topic);

                        if (messagesData.messages) {
                            for (const message of messagesData.messages) {
                                const messageElement = await addMessage(message.content, message.sender, message.relatedTopics || []);
                                if (messageElement) {
                                    messageElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }
                            }
                        }

                        currentChatId = chat.chat_id;
                        textarea.value = '';

                    }, 500);

                } catch (error) {
                    console.error('Error loading chat messages:', error);
                }
            });
            
            chatList.appendChild(chatItem);
        });

    } catch (error) {
        console.error('Error loading recent chats:', error);
    }
}

document.addEventListener('DOMContentLoaded', loadRecentChats);

function updateRecentChatsUI(chats) {
    console.log('Force updating recent chats UI');
    
    const chatList = document.querySelector('.chat-list');
    if (!chatList) {
        console.error('Chat list container not found');
        return;
    }

    chatList.innerHTML = '';

    if (!chats || chats.length === 0) {
        fetch('VotalityChat2.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'getRecentChats'
            }),
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.chats && data.chats.length > 0) {
                displayChats(data.chats);
            } else {
                chatList.innerHTML = `
                    <div class="chat-item no-chats" style="background: transparent !important;">
                        <span class="chat-name">No recent chats</span>
                    </div>
                `;
            }
        });
    } else {
        displayChats(chats);
    }

    function displayChats(chatsToDisplay) {
        chatsToDisplay.forEach(chat => {
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            // Adding transparent background as important
            chatItem.style.cssText = 'background: transparent !important;';
            
            if (chat.chat_id === currentChatId) {
                chatItem.classList.add('active');
            }

            const chatName = document.createElement('span');
            chatName.className = 'chat-name';
            chatName.textContent = chat.topic || 'New Chat';
            
            chatItem.addEventListener('click', () => {
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.remove('active');
                });
                chatItem.classList.add('active');
                currentChatId = chat.chat_id;
                loadChat(chat.chat_id);
            });

            chatItem.appendChild(chatName);
            chatList.appendChild(chatItem);
        });
    }
}
// Add this helper function to load chat content
async function loadChat(chatId) {
console.log('Loading chat:', chatId);

try {
    const response = await fetch('VotalityChat2.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'loadChat',
            chatId: chatId
        }),
        credentials: 'same-origin'
    });

    const data = await response.json();
    console.log('Chat data received:', data);

    if (data.error) {
        console.error('Error loading chat:', data.error);
        return;
    }

    // Clear existing chat content
    const chatContainer = document.getElementById('chat-container');
    if (chatContainer) {
        chatContainer.innerHTML = '';
    }

    // Remove initial content if present
    const initialContent = document.getElementById('initial-content');
    if (initialContent) {
        initialContent.style.display = 'none';
    }

    // Remove suggested queries if present
    const suggestedQueries = document.getElementById('suggested-queries');
    if (suggestedQueries) {
        suggestedQueries.style.display = 'none';
    }

    // Add chat messages
    if (data.messages && data.messages.length > 0) {
        data.messages.forEach(message => {
            addMessage(message.content, message.sender, message.relatedTopics);
        });
    }

    // Update chat topic if available
    if (data.topic) {
        updateChatTopicDisplay(data.topic);
    }

    // Show chat container
    if (chatContainer) {
        chatContainer.style.display = 'block';
        chatContainer.classList.add('fade-in');
    }

} catch (error) {
    console.error('Failed to load chat:', error);
}
}

// Update the existing event listener for the new chat button
document.addEventListener('DOMContentLoaded', function() {
console.log('Setting up new chat button handler');

const newChatButton = document.querySelector('.sidebar-button-container');
if (newChatButton) {
    newChatButton.addEventListener('click', async () => {
        console.log('New chat button clicked');
        try {
            await createNewChat();
            loadRecentChats();
        } catch (error) {
            console.error('Error handling new chat:', error);
        }
    });
}

// Initial load of recent chats
loadRecentChats();
});

async function createNewChat() {
try {
    const response = await fetch('VotalityChat2.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'createNewChat'
        }),
    });

    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    if (data.error) {
        throw new Error(data.error);
    }

    // Update current chat ID
    currentChatId = data.chatId;

    // Reset UI
    resetUI();

    // Clear chat container
    chatContainer.innerHTML = '';

    // Show initial content
    initialContent.style.display = 'block';
    suggestedQueries.style.display = 'flex';
    footerLinks.style.display = 'block';
    
    // Reset header topic
    if (chatTopicElement) {
        chatTopicElement.textContent = 'Current Chat Topic';
    }

    // Reset textarea
    if (textarea) {
        textarea.value = '';
        textarea.placeholder = "Ask Votality anything...";
    }

    // Remove white background if present
    document.body.classList.remove('white-background');

    // Reset desktop top nav
    const desktopTopNav = document.querySelector('.desktop-top-nav');
    if (desktopTopNav) {
        desktopTopNav.style.display = 'none';
        desktopTopNav.classList.remove('fade-in');
    }

    // Reset chat container and disclaimer
    chatContainer.classList.remove('fade-in');
    if (disclaimer) {
        disclaimer.style.display = 'none';
        disclaimer.classList.remove('fade-in');
    }

    // Remove any transitions
    initialContent.classList.remove('fade-out');
    suggestedQueries.classList.remove('fade-out');
    footerLinks.classList.remove('fade-out');
    textareaContainer.classList.remove('repositioned');

    // Load recent chats to update the sidebar
    await loadRecentChats();

    return currentChatId;
} catch (error) {
    console.error('Error creating new chat:', error);
    throw error;
}
}

// Event listener for new chat button
document.addEventListener('DOMContentLoaded', function() {
const newChatButton = document.querySelector('.sidebar-button-container');
if (newChatButton) {
    newChatButton.addEventListener('click', async () => {
        try {
            await createNewChat();
        } catch (error) {
            console.error('Error handling new chat:', error);
        }
    });
}

// Initial load of recent chats
loadRecentChats();
});

function resetUI() {
// Reset UI elements to initial state
initialContent.style.display = 'block';
suggestedQueries.style.display = 'flex';
footerLinks.style.display = 'block';
chatContainer.style.display = 'none';
if (window.innerWidth > 640) {
disclaimer.style.display = 'none';
} else {
disclaimer.style.display = 'none !important';
}    
initialContent.classList.remove('fade-out');
suggestedQueries.classList.remove('fade-out');
footerLinks.classList.remove('fade-out');
chatContainer.classList.remove('fade-in');
disclaimer.classList.remove('fade-in');

textareaContainer.classList.remove('repositioned');
document.body.classList.remove('white-background');

textarea.value = '';

if (desktopTopNav) {
    desktopTopNav.style.display = 'none';
    desktopTopNav.classList.remove('fade-in');
}

// Reset chat topic
currentChatTopic = null;
updateChatTopicDisplay('Current Chat Topic');
}

function handleAttachment() {
// Implement file attachment logic here
console.log('Attachment button clicked');
// You can add file input and handling logic here
}

async function readFileAsDataURL(file) {
return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
});
}

// Event listener for attachment button
attachmentButton.addEventListener('click', handleAttachment);

// Event listener for suggested queries
suggestedQueries.querySelectorAll('.query-chip').forEach(chip => {
chip.addEventListener('click', function() {
    const query = this.textContent.trim();
    textarea.value = query;
    submitButton.click();
});
});

// Initialize
document.addEventListener('DOMContentLoaded', () => {
loadRecentChats();
// Add any other initialization code here
});   

// Global variable to store attached files
let attachedFiles = [];

// Create hidden file input
const fileInput = document.createElement('input');
fileInput.type = 'file';
fileInput.multiple = true;
fileInput.accept = 'image/*,.pdf,.doc,.docx';
fileInput.style.display = 'none';
document.body.appendChild(fileInput);

// Handle attachment button click
attachmentButton.addEventListener('click', function() {
if (attachedFiles.length > 0) {
    // Show file panel if files are attached
    toggleFilePanel();
} else {
    // Trigger file selection if no files attached
    fileInput.click();
}
});

// Handle file selection
fileInput.addEventListener('change', function(e) {
const files = Array.from(e.target.files);

// Check if adding new files would exceed the limit
const totalFiles = attachedFiles.length + files.length;
if (totalFiles > 3) {
    alert('Maximum 3 files allowed');
    return;
}

// Check file size limits
const validFiles = files.filter(file => {
    const maxSize = 3.75 * 1024 * 1024; // 3.75MB in bytes
    return file.size <= maxSize;
});

if (validFiles.length > 0) {
    // Add new files to existing ones
    attachedFiles = [...attachedFiles, ...validFiles];
    updateAttachmentButtonUI();
    createFilePanel();
    
    // Show the panel after creating it
    const panel = document.querySelector('.file-panel');
    if (panel) {
        panel.style.display = 'block';
    }
}

// Reset file input
fileInput.value = '';
});

// Update attachment button UI
function updateAttachmentButtonUI() {
const attachmentContainer = attachmentButton.querySelector('.attachment-container');

attachmentContainer.innerHTML = attachedFiles.length > 0 
    ? `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-4 w-4 text-black">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
    </svg>`
    : `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-4 w-4 text-black">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
    </svg>`;
}

function createFilePanel() {
const existingPanel = document.querySelector('.file-panel');
if (existingPanel) {
    existingPanel.remove();
}

const panel = document.createElement('div');
panel.className = 'file-panel';
panel.style.display = 'none';

const header = document.createElement('div');
header.className = 'file-panel-header';

const title = document.createElement('div');
title.className = 'header-title';
title.textContent = 'Attached Files';

const actions = document.createElement('div');
actions.className = 'header-actions';

const addButton = document.createElement('button');
addButton.className = 'header-button';
addButton.disabled = attachedFiles.length >= 3;
addButton.style.opacity = attachedFiles.length >= 3 ? '0.5' : '1';
addButton.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-4 w-4">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
    </svg>
    <span>Add</span>
`;
addButton.addEventListener('click', (e) => {
    e.stopPropagation();
    if (attachedFiles.length < 3) {
        fileInput.click();
    }
});

const clearButton = document.createElement('button');
clearButton.className = 'header-button';
clearButton.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-4 w-4">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
    </svg>
    <span>Clear</span>
`;
clearButton.addEventListener('click', (e) => {
    e.stopPropagation();
    attachedFiles = [];
    panel.remove();
    updateAttachmentButtonUI();
});

actions.appendChild(addButton);
actions.appendChild(clearButton);
header.appendChild(title);
header.appendChild(actions);
panel.appendChild(header);

const filesContainer = document.createElement('div');
filesContainer.className = 'files-container';

attachedFiles.forEach((file) => {
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    
    fileItem.innerHTML = `
        <div class="file-info">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
            </svg>
            <span>${file.name}</span>
        </div>`;
        
    filesContainer.appendChild(fileItem);
});

panel.appendChild(filesContainer);
document.body.appendChild(panel);
positionFilePanel();
}

function positionFilePanel() {
const panel = document.querySelector('.file-panel');
if (panel) {
    const buttonRect = attachmentButton.getBoundingClientRect();
    panel.style.position = 'absolute';
    panel.style.left = `${buttonRect.left}px`;
    panel.style.bottom = `${window.innerHeight - buttonRect.top + 10}px`;
}
}

function toggleFilePanel() {
const panel = document.querySelector('.file-panel');
if (panel) {
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}
}

document.addEventListener('DOMContentLoaded', function() {
const toggleButton = document.querySelector('.toggle-sidebar');
const sidebar = document.querySelector('.sidebar');

// Set the sidebar to be expanded by default
sidebar.classList.add('collapsed');

toggleButton.addEventListener('click', function() {
    // Collapse the sidebar when the button is clicked
    sidebar.classList.add('collapsed');
    sidebar.classList.remove('expanded');

    // Update tooltip text to always say "Collapse"
    toggleButton.setAttribute('data-tooltip', 'Collapse');

    // No need for rotation effect on the sidebar icon
    const sidebarIcon = toggleButton.querySelector('[data-lucide="sidebar"]');
    if (sidebarIcon) {
        sidebarIcon.style.transform = 'none'; // No rotation
    }
});

// Handle window resize
window.addEventListener('resize', function() {
    if (window.innerWidth <= 768 && sidebar.classList.contains('expanded')) {
        sidebar.classList.remove('expanded');
        sidebar.classList.add('collapsed');
    }
});
});

function addEditControls(messageElement) {
// Create edit controls container
const editControls = document.createElement('div');
editControls.className = 'message-edit-controls';

// Create edit button
const editButton = document.createElement('button');
editButton.className = 'edit-button';
editButton.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
</svg>
Edit
`;

// Create submit and cancel buttons (initially hidden)
const submitButton = document.createElement('button');
submitButton.className = 'submit-edit-button';
submitButton.style.display = 'none';
submitButton.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"/>
    </svg>
    Save
`;

const cancelButton = document.createElement('button');
cancelButton.className = 'cancel-edit-button';
cancelButton.style.display = 'none';
cancelButton.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
    </svg>
    Cancel
`;

// Add event listeners
editButton.addEventListener('click', () => startEditing(messageElement));
submitButton.addEventListener('click', () => submitEdit(messageElement));
cancelButton.addEventListener('click', () => cancelEdit(messageElement));

// Add buttons to controls in the new order: Save first, then Cancel
editControls.appendChild(editButton);
editControls.appendChild(cancelButton);  // Move Cancel before Submit
editControls.appendChild(submitButton);  // Move Submit after Cancel

// Add controls to message
messageElement.appendChild(editControls);
}

function startEditing(messageElement) {
const originalText = messageElement.childNodes[0].textContent;
messageElement.classList.add('editing');

// Create textarea
const textarea = document.createElement('textarea');
textarea.className = 'message-edit-input';
textarea.value = originalText;

// Store original text for cancellation
textarea.dataset.originalText = originalText;

// Replace text with textarea
messageElement.replaceChild(textarea, messageElement.childNodes[0]);
textarea.focus();

// Show/hide appropriate buttons
const controls = messageElement.querySelector('.message-edit-controls');
controls.querySelector('.edit-button').style.display = 'none';
controls.querySelector('.submit-edit-button').style.display = 'flex';
controls.querySelector('.cancel-edit-button').style.display = 'flex';
}

function submitEdit(messageElement) {
const textarea = messageElement.querySelector('.message-edit-input');
const newText = textarea.value;

// Create new text node
const textNode = document.createTextNode(newText);
messageElement.replaceChild(textNode, textarea);

// Reset UI
finishEditing(messageElement);

// Resend the edited message to get new AI response
sendMessage(newText);
}

function cancelEdit(messageElement) {
const textarea = messageElement.querySelector('.message-edit-input');
const originalText = textarea.dataset.originalText;

// Restore original text
const textNode = document.createTextNode(originalText);
messageElement.replaceChild(textNode, textarea);

// Reset UI
finishEditing(messageElement);
}

function finishEditing(messageElement) {
messageElement.classList.remove('editing');

// Reset buttons
const controls = messageElement.querySelector('.message-edit-controls');
controls.querySelector('.edit-button').style.display = 'flex';
controls.querySelector('.submit-edit-button').style.display = 'none';
controls.querySelector('.cancel-edit-button').style.display = 'none';
}

// Helper function to create source item element
function createSourceItem(source) {
    const sourceItem = document.createElement('div');
    sourceItem.style.display = 'flex';
    sourceItem.style.flexDirection = 'column';
    sourceItem.style.backgroundColor = isDarkMode() ? '#232323' : '#f3f4f6';
    sourceItem.style.borderRadius = '6px';
    sourceItem.style.padding = '8px 12px';
    sourceItem.style.width = '150px';
    sourceItem.style.flexShrink = '0';
    sourceItem.style.cursor = 'pointer';
    sourceItem.style.transition = 'background-color 0.2s ease';
    sourceItem.style.position = 'relative';

    sourceItem.addEventListener('mouseover', () => {
        sourceItem.style.backgroundColor = isDarkMode() ? '#2a2d33' : '#e5e7eb';
    });
    sourceItem.addEventListener('mouseout', () => {
        sourceItem.style.backgroundColor = isDarkMode() ? '#232323' : '#f3f4f6';
    });

    // Create title element
    const titleElement = document.createElement('div');
    titleElement.style.fontSize = '0.875rem';
    titleElement.style.color = isDarkMode() ? '#ffffff' : '#374151';
    titleElement.style.whiteSpace = 'nowrap';
    titleElement.style.overflow = 'hidden';
    titleElement.style.textOverflow = 'ellipsis';
    titleElement.style.marginBottom = '2px';
    titleElement.textContent = source.name;

    // Create subtitle/metric element
    const metricElement = document.createElement('div');
    metricElement.style.fontSize = '0.75rem';
    metricElement.style.color = isDarkMode() ? '#9CA3AF' : '#6B7280';
    metricElement.style.whiteSpace = 'nowrap';
    metricElement.style.display = 'flex';
    metricElement.style.alignItems = 'center';
    metricElement.style.gap = '4px';
    
    const metricText = document.createElement('span');
    metricText.textContent = source.metric;
    
    const copyIcon = document.createElement('span');
    copyIcon.innerHTML = '<i data-lucide="copy" class="w-3 h-3"></i>';
    
    metricElement.appendChild(metricText);
    metricElement.appendChild(copyIcon);

    sourceItem.appendChild(titleElement);
    sourceItem.appendChild(metricElement);
    
    return sourceItem;
}

function addMessage(text, sender, relatedTopics = []) {
    return new Promise((resolve) => {
        const chatContainer = document.querySelector('.chat-container');
        let messageElement;
        
        if (sender === 'user') {
            const chatGroup = document.createElement('div');
            chatGroup.className = 'chat-group';
            
            messageElement = document.createElement('div');
            messageElement.className = 'message user-message';
            messageElement.textContent = text;
            
            chatGroup.appendChild(messageElement);
            chatContainer.appendChild(chatGroup);
            
            addEditControls(messageElement);
            resolve(messageElement);
        } else {
            const lastChatGroup = chatContainer.lastElementChild;

            // Get existing loading container
            const loadingContainer = lastChatGroup.querySelector('.loading-container');

            // Create source container with horizontal layout
            const sourcesContainer = document.createElement('div');
            sourcesContainer.className = 'sources-container';
            sourcesContainer.style.display = 'flex';
            sourcesContainer.style.flexDirection = 'row';
            sourcesContainer.style.gap = '8px';
            sourcesContainer.style.padding = '1px 16px';
            sourcesContainer.style.marginBottom = '12px';
            sourcesContainer.style.flexWrap = 'nowrap';
            sourcesContainer.style.alignItems = 'stretch';

            const sourceData = [
                { name: 'Annual & Interim Reports', metric: '16 quarters' },
                { name: 'News Releases', metric: '342 releases' },
                { name: 'SEC Filings', metric: '53K words' },
                { name: 'Corporate Governance', metric: '18 documents' }
            ];

            sourceData.forEach(source => {
                const sourceItem = document.createElement('div');
                sourceItem.style.display = 'flex';
                sourceItem.style.flexDirection = 'column';
                sourceItem.style.backgroundColor = isDarkMode() ? '#232323' : '#f3f4f6';
                sourceItem.style.borderRadius = '6px';
                sourceItem.style.padding = '8px 12px';
                sourceItem.style.width = '170px';
                sourceItem.style.flexShrink = '0';
                sourceItem.style.cursor = 'pointer';
                sourceItem.style.transition = 'background-color 0.2s ease';
                sourceItem.style.justifyContent = 'flex-start';

                sourceItem.addEventListener('mouseover', () => {
                    sourceItem.style.backgroundColor = isDarkMode() ? '#2a2d33' : '#e5e7eb';
                });
                sourceItem.addEventListener('mouseout', () => {
                    sourceItem.style.backgroundColor = isDarkMode() ? '#232323' : '#f3f4f6';
                });

                const titleContainer = document.createElement('div');
                titleContainer.style.display = 'flex';
                titleContainer.style.flexDirection = 'column';
                titleContainer.style.width = '100%';
                titleContainer.style.alignItems = 'flex-start';

                const titleText = document.createElement('div');
                titleText.style.fontSize = '0.875rem';
                titleText.style.color = isDarkMode() ? '#ffffff' : '#374151';
                titleText.style.whiteSpace = 'nowrap';
                titleText.style.overflow = 'hidden';
                titleText.style.textOverflow = 'ellipsis';
                titleText.style.marginBottom = '2px';
                titleText.style.width = '100%';
                titleText.style.textAlign = 'left';
                titleText.textContent = source.name;

                const metricContainer = document.createElement('div');
                metricContainer.style.display = 'flex';
                metricContainer.style.alignItems = 'center';
                metricContainer.style.gap = '4px';
                metricContainer.style.width = '100%';
                metricContainer.style.justifyContent = 'flex-start';

                const metricText = document.createElement('span');
                metricText.style.fontSize = '0.75rem';
                metricText.style.color = isDarkMode() ? '#9CA3AF' : '#6B7280';
                metricText.textContent = source.metric;

                const linkIcon = document.createElement('span');
                linkIcon.innerHTML = '<i data-lucide="external-link" class="w-3 h-3"></i>';
                linkIcon.style.color = isDarkMode() ? '#9CA3AF' : '#6B7280';

                metricContainer.appendChild(metricText);
                metricContainer.appendChild(linkIcon);

                titleContainer.appendChild(titleText);
                titleContainer.appendChild(metricContainer);
                sourceItem.appendChild(titleContainer);
                sourcesContainer.appendChild(sourceItem);
            });

            // Insert sources container after loading container if it exists
            if (loadingContainer) {
                loadingContainer.after(sourcesContainer);
            } else {
                lastChatGroup.appendChild(sourcesContainer);
            }

            // Parse market info if present in the text
            if (text.includes('Market Info:')) {
                const marketInfoMatch = text.match(/Market Info:\s*(.*?)\|(.*?)\|(\d+\.?\d*)\|([-+]?\d+\.?\d*)(?=\n|$)/);
                if (marketInfoMatch) {
                    const [, companyName, symbol, currentPrice, priceChange] = marketInfoMatch;
                    const stockData = {
                        companyName: companyName.trim(),
                        symbol: symbol.trim(),
                        currentPrice: currentPrice,
                        priceChange: priceChange,
                        priceChangePercent: ((parseFloat(priceChange) / parseFloat(currentPrice)) * 100).toFixed(2),
                        tradingStatus: 'Regular Hours',
                        lastUpdated: getNYSETime()
                    };

                    const marketDataSection = createMarketDataSection(stockData);
                    
                    const timeUpdateInterval = setInterval(() => {
                        const timeElement = marketDataSection.querySelector('.trading-status span:last-child');
                        if (timeElement) {
                            timeElement.textContent = getNYSETime();
                        }
                    }, 5 * 60 * 1000);

                    marketDataSection.dataset.timeInterval = timeUpdateInterval;
                    
                    lastChatGroup.appendChild(marketDataSection);
                }
            }

            // Create an outer wrapper for proper positioning context
            const outerWrapper = document.createElement('div');
            outerWrapper.style.position = 'relative';
            outerWrapper.style.width = '100%';
            outerWrapper.style.marginLeft = '0px';
            outerWrapper.style.zIndex = '1000';

            // Create the message container
            const messageContainer = document.createElement('div');
            messageContainer.style.width = '100%';
            messageContainer.style.boxSizing = 'border-box';
            messageContainer.style.position = 'relative';
            messageContainer.style.marginTop = '0px';

            // Remove the Market Info section from displayed text
            let displayText = text;
            if (text.includes('Market Info:')) {
                displayText = text.split('Market Info:')[0].trim();
            }

            // Create AI message
            messageElement = document.createElement('div');
            messageElement.className = 'message ai-message';
            messageElement.style.width = '100%';
            
            // Add message content with animation
            const messageContent = document.createElement('div');
            messageContent.className = 'ai-message-content';
            
            const paragraphs = displayText.split('\n\n');
            let delay = 0;

            paragraphs.forEach((paragraph, index) => {
                if (paragraph.trim() !== '') {
                    const paragraphContainer = document.createElement('div');
                    paragraphContainer.className = 'ai-message-paragraph-container';

                    const pElement = document.createElement('p');
                    pElement.className = 'ai-message-paragraph';
                    
                    const words = paragraph.split(' ');
                    words.forEach((word, wordIndex) => {
                        const span = document.createElement('span');
                        span.textContent = word + ' ';
                        span.style.opacity = '0';
                        span.style.animation = `fadeIn 0.02s forwards ${delay}ms`;
                        pElement.appendChild(span);
                        delay += 2;
                    });
                    
                    paragraphContainer.appendChild(pElement);
                    messageContent.appendChild(paragraphContainer);
                    delay += 20;
                }
            });
            
            messageElement.appendChild(messageContent);

            // Add interaction buttons
            const interactions = document.createElement('div');
            interactions.className = 'message-interactions';
            interactions.innerHTML = `
                <div class="message-feedback">
                    <div class="tooltip-container">
                        <button class="interaction-button" aria-label="Like message">
                            <i data-lucide="thumbs-up" class="w-4 h-4"></i>
                        </button>
                        <div class="tooltip">
                            <span class="tooltip-text">Like</span>
                        </div>
                    </div>
                    <div class="tooltip-container">
                        <button class="interaction-button" aria-label="Dislike message">
                            <i data-lucide="thumbs-down" class="w-4 h-4"></i>
                        </button>
                        <div class="tooltip">
                            <span class="tooltip-text">Dislike</span>
                        </div>
                    </div>
                </div>
                <div class="message-actions">
                    <div class="tooltip-container">
                        <button class="interaction-button" aria-label="Copy message">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                        </button>
                        <div class="tooltip">
                            <span class="tooltip-text">Copy</span>
                        </div>
                    </div>
                    <div class="tooltip-container">
                        <button class="interaction-button" aria-label="Retry message">
                            <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                        </button>
                        <div class="tooltip">
                            <span class="tooltip-text">Retry</span>
                        </div>
                    </div>
                </div>
            `;

            // Add interaction handlers
            const likeButton = interactions.querySelector('[aria-label="Like message"]');
            const dislikeButton = interactions.querySelector('[aria-label="Dislike message"]');

            likeButton.addEventListener('click', () => {
                likeButton.style.color = '#059669';
                dislikeButton.style.color = '';
                handleLike(messageElement);
            });

            dislikeButton.addEventListener('click', () => {
                dislikeButton.style.color = '#DC2626';
                likeButton.style.color = '';
                handleDislike(messageElement);
            });

            const copyButton = interactions.querySelector('[aria-label="Copy message"]');
            copyButton.addEventListener('click', () => {
                navigator.clipboard.writeText(displayText)
                    .then(() => {
                        copyButton.style.color = '#059669';
                        setTimeout(() => {
                            copyButton.style.color = '';
                        }, 1000);
                    })
                    .catch(console.error);
            });

            const retryButton = interactions.querySelector('[aria-label="Retry message"]');
            retryButton.addEventListener('click', () => {
                const lastUserMessage = chatContainer.querySelector('.user-message:last-of-type');
                if (lastUserMessage) {
                    const messageText = lastUserMessage.textContent;
                    sendMessage(messageText);
                }
            });

            messageElement.appendChild(interactions);
            messageContainer.appendChild(messageElement);
            outerWrapper.appendChild(messageContainer);
            lastChatGroup.appendChild(outerWrapper);

            // Initialize Lucide icons
            lucide.createIcons();

            setTimeout(() => {
                if (relatedTopics.length > 0) {
                    const relatedHeading = document.createElement('div');
                    relatedHeading.className = 'section-heading related-heading';
                    relatedHeading.textContent = 'Related';
                    lastChatGroup.appendChild(relatedHeading);

                    const relatedContainer = document.createElement('div');
                    relatedContainer.className = 'related-container';

                    relatedTopics.forEach(topic => {
                        const relatedItem = document.createElement('div');
                        relatedItem.className = 'related-item';

                        const textSpan = document.createElement('span');
                        textSpan.className = 'related-item-text';
                        textSpan.textContent = topic;

                        const iconSpan = document.createElement('span');
                        iconSpan.className = 'related-item-icon';
                        iconSpan.innerHTML = '<i data-lucide="plus"></i>';

                        relatedItem.appendChild(textSpan);
                        relatedItem.appendChild(iconSpan);
                        relatedContainer.appendChild(relatedItem);

                        relatedItem.addEventListener('click', () => sendRelatedTopic(topic));
                    });

                    lastChatGroup.appendChild(relatedContainer);
                    lucide.createIcons();
                }
                resolve(messageElement);
            }, delay + 100);
        }
    });
}

function addMessageInteractions(messageElement, sender) {
if (sender === 'ai') {
    const interactions = document.createElement('div');
    interactions.className = 'message-interactions';
    interactions.innerHTML = `
        <div class="message-feedback">
            <div class="tooltip-container">
                <button class="interaction-button" aria-label="Like message">
                    <i data-lucide="thumbs-up" class="w-4 h-4"></i>
                </button>
                <div class="tooltip">
                    <span class="tooltip-text">Like</span>
                </div>
            </div>
            <div class="tooltip-container">
                <button class="interaction-button" aria-label="Dislike message">
                    <i data-lucide="thumbs-down" class="w-4 h-4"></i>
                </button>
                <div class="tooltip">
                    <span class="tooltip-text">Dislike</span>
                </div>
            </div>
        </div>
        <div class="message-actions">
            <div class="tooltip-container">
                <button class="interaction-button" aria-label="Copy message">
                    <i data-lucide="copy" class="w-4 h-4"></i>
                </button>
                <div class="tooltip">
                    <span class="tooltip-text">Copy</span>
                </div>
            </div>
            <div class="tooltip-container">
                <button class="interaction-button" aria-label="Retry message">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                </button>
                <div class="tooltip">
                    <span class="tooltip-text">Retry</span>
                </div>
            </div>
        </div>
    `;

    // Add event listeners
    const likeButton = interactions.querySelector('[aria-label="Like message"]');
    const dislikeButton = interactions.querySelector('[aria-label="Dislike message"]');
    const copyButton = interactions.querySelector('[aria-label="Copy message"]');
    const retryButton = interactions.querySelector('[aria-label="Retry message"]');

    likeButton.addEventListener('click', () => {
        const icon = likeButton.querySelector('i');
        icon.style.fill = '#000';
        icon.style.color = '#000000';
        dislikeButton.querySelector('i').removeAttribute('style');
        handleLike(messageElement);
    });

    dislikeButton.addEventListener('click', () => {
        createFeedbackForm();
        showFeedbackForm();
        handleDislike(messageElement);
    });

    copyButton.addEventListener('click', () => handleCopy(messageElement));
    retryButton.addEventListener('click', () => handleRetry(messageElement));

    messageElement.appendChild(interactions);
    
    // Initialize Lucide icons for the new elements
    lucide.createIcons(interactions);
}
}

function handleLike(messageElement) {
console.log('Message liked');
showFeedbackPopup(); // Call the function to show the feedback popup
// Implement any additional like functionality here, if needed
}

function handleDislike(messageElement) {
    const interactionsDiv = messageElement.querySelector('.message-interactions');
    const feedbackModal = document.getElementById('feedback-modal');
    
    // Position the modal relative to the interactions div
    interactionsDiv.style.position = 'relative';
    interactionsDiv.appendChild(feedbackModal);
    
    // Show the modal
    feedbackModal.style.display = 'block';
    setTimeout(() => {
        feedbackModal.classList.add('active');
    }, 0);
}

function handleCopy(messageElement) {
const messageText = messageElement.querySelector('.ai-message-paragraph').textContent;
navigator.clipboard.writeText(messageText).then(() => {
    console.log('Message copied to clipboard');
    // You can add a visual feedback here, like a temporary tooltip
});
}

function handleRetry(messageElement) {
const lastUserMessage = document.querySelector('.user-message:last-of-type');
if (lastUserMessage) {
    const messageText = lastUserMessage.textContent;
    sendMessage(messageText);
}
}

// Function to show feedback popup
function showFeedbackPopup() {
const popup = document.getElementById('feedback-popup');
popup.style.display = 'block';
popup.style.opacity = '1';
popup.style.top = '20px'; // Show the popup

// Hide the popup after 3 seconds
setTimeout(() => {
    popup.style.opacity = '0';
    popup.style.top = '-50px'; // Move it out of view
    setTimeout(() => {
        popup.style.display = 'none'; // Hide it completely
    }, 500); // Wait for the fade-out transition
}, 3000); // Show for 3 seconds
}

// Add event listener to the like button
const likeButton = document.querySelector('[aria-label="Like message"]');
if (likeButton) {
likeButton.addEventListener('click', showFeedbackPopup);
}

dislikeButton.addEventListener('click', () => {
    const icon = dislikeButton.querySelector('i');
    icon.style.fill = '#000';
    icon.style.color = '#000000';
    likeButton.querySelector('i').removeAttribute('style');
    handleDislike(messageElement);
    showFeedbackModal();
});

// Add these functions to handle the feedback modal
function showFeedbackModal() {
const modal = document.getElementById('feedback-modal');
modal.classList.add('active');
}

function closeFeedbackModal() {
    const modal = document.getElementById('feedback-modal');
    modal.classList.remove('active');
    setTimeout(() => {
        modal.style.display = 'none';
        // Move modal back to body after closing
        document.body.appendChild(modal);
    }, 200);
}

// Update the feedback options click handlers
document.querySelectorAll('.feedback-option').forEach(button => {
    button.addEventListener('click', function() {
        // Remove selected state from all buttons
        document.querySelectorAll('.feedback-option').forEach(btn => {
            btn.classList.remove('selected');
        });
        
        // Add selected state to clicked button
        this.classList.add('selected');
        
        // Submit the feedback
        submitFeedback(this.textContent);
    });
});

// Close modal when clicking outside
document.getElementById('feedback-modal').addEventListener('click', function(e) {
if (e.target === this) {
    closeFeedbackModal();
}
});

function submitFeedback(option) {
    const formData = new FormData();
    formData.append('feedback', option);

    fetch('submit_feedback.php', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close feedback modal
            closeFeedbackModal();
            
            // Show feedback popup
            const popup = document.getElementById('feedback-popup');
            popup.style.display = 'block';
            popup.style.opacity = '1';
            popup.style.top = '20px';

            // Hide popup after 3 seconds
            setTimeout(() => {
                popup.style.opacity = '0';
                popup.style.top = '-50px';
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 500);
            }, 3000);
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while submitting feedback.');
    });
}

// Add event listeners to query chips
document.addEventListener('DOMContentLoaded', function() {
console.log("DOM fully loaded and parsed");

const queryChips = document.querySelectorAll('.query-chip');
console.log("Query chips found:", queryChips.length); // Log the number of query chips found

queryChips.forEach(chip => {
    chip.addEventListener('click', function() {
        const queryText = this.getAttribute('data-query'); // Get the query text from data attribute
        textarea.value = queryText; // Set the textarea value to the query text
        textarea.placeholder = staticText + queryText; // Update the placeholder
        
        // Debugging logs
        console.log("Query chip clicked:", queryText); // Log the clicked query
        console.log("Updated placeholder:", textarea.placeholder); // Log the new placeholder
        
        submitButton.click(); // Optionally trigger the submit button click
    });
});
});

document.addEventListener('DOMContentLoaded', function() {
console.log("DOM fully loaded and parsed");

const staticText = "Ask Votality about... "; // Original placeholder
const textarea = document.getElementById('query-input'); // Ensure this matches your textarea ID
const submitButton = document.getElementById('submit-button'); // Ensure this matches your submit button ID

const queryChips = document.querySelectorAll('.query-chip');
console.log("Query chips found:", queryChips.length); // Log the number of query chips found

queryChips.forEach(chip => {
    chip.addEventListener('click', function() {
        const queryText = this.getAttribute('data-query'); // Get the query text from data attribute
        textarea.value = queryText; // Set the textarea value to the query text
        textarea.placeholder = staticText + queryText; // Update the placeholder
        
        // Debugging logs
        console.log("Query chip clicked:", queryText); // Log the clicked query
        console.log("Updated placeholder:", textarea.placeholder); // Log the new placeholder
        
        // Optionally trigger the submit button click
        submitButton.click();
    });
});
});

document.querySelector('[data-feedback]').addEventListener('click', () => {
window.location.href = 'feedback.html';
});

async function updateChart(period) {
    try {
        const response = await fetch('VotalityChat2.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'getMarketData',
                period: period,
                chatId: currentChatId
            }),
            credentials: 'same-origin'
        });
        
        const data = await response.json();
        if (data.error) {
            console.error('Error fetching market data:', data.error);
            return;
        }

        const chart = Chart.getChart('priceChart');
        if (chart) {
            chart.data.labels = data.marketData.timePoints;
            chart.data.datasets[0].data = data.marketData.prices;
            chart.update();
        }
    } catch (error) {
        console.error('Error updating chart:', error);
    }
}
function initializeChart(canvas) {
    const ctx = canvas.getContext('2d');
    
    // Generate realistic market data
    const hours = ['9:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00'];
    const basePrice = 189.37;
    const prices = [];
    let currentPrice = basePrice;
    
    // Generate semi-random prices with realistic market movement
    hours.forEach((hour, index) => {
        const trend = Math.sin(index / 5) * 0.3;
        const noise = (Math.random() - 0.5) * 0.4;
        const change = trend + noise;
        currentPrice = currentPrice + change;
        prices.push(currentPrice);
    });

    const gradient = ctx.createLinearGradient(0, 0, 0, 250);
    gradient.addColorStop(0, 'rgba(16, 185, 129, 0.2)');
    gradient.addColorStop(1, 'rgba(16, 185, 129, 0.0)');

    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: hours,
            datasets: [{
                label: 'Price',
                data: prices,
                borderColor: '#10B981',
                backgroundColor: gradient,
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(17, 24, 39, 0.9)',
                    titleColor: '#9CA3AF',
                    bodyColor: '#ffffff',
                    borderColor: '#4B5563',
                    borderWidth: 1,
                    padding: 8,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            return `$${context.parsed.y.toFixed(2)}`;
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#9CA3AF',
                        font: {
                            size: 11
                        },
                        maxRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 6
                    },
                    border: {
                        display: false
                    }
                },
                y: {
                    position: 'left',
                    grid: {
                        color: 'rgba(75, 85, 99, 0.1)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#9CA3AF',
                        font: {
                            size: 11
                        },
                        padding: 8,
                        callback: function(value) {
                            return `$${value.toFixed(2)}`;
                        }
                    },
                    border: {
                        display: false
                    }
                }
            }
        }
    });
}

function updateChart(period) {
    // Implement period-specific data updates here
    console.log(`Updating chart for period: ${period}`);
}

function startMarketDataUpdates(symbol) {
    // Update every 5 seconds for real-time data
    const updateInterval = setInterval(async () => {
        try {
            const response = await fetch('VotalityChat2.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'getLatestPrice',
                    symbol: symbol
                }),
                credentials: 'same-origin'
            });
            
            const data = await response.json();
            if (data.error) {
                console.error('Error fetching latest price:', data.error);
                return;
            }

            // Update price display
            const priceElement = document.querySelector('.current-price');
            const changeElement = document.querySelector('.price-change');
            if (priceElement && changeElement) {
                priceElement.textContent = `$${data.currentPrice.toFixed(2)}`;
                
                const change = data.priceChange;
                const changePercent = data.priceChangePercent;
                changeElement.className = `price-change ${change >= 0 ? 'positive' : 'negative'}`;
                changeElement.innerHTML = `
                    <span>$${Math.abs(change).toFixed(2)}</span>
                    <span>(${changePercent}%)</span>
                `;
            }

            // Update chart with new price point
            const chart = Chart.getChart('priceChart');
            if (chart) {
                chart.data.datasets[0].data.push(data.currentPrice);
                chart.data.labels.push(data.timestamp);
                // Remove oldest point to keep chart looking clean
                if (chart.data.datasets[0].data.length > 100) {
                    chart.data.datasets[0].data.shift();
                    chart.data.labels.shift();
                }
                chart.update('none'); // Use 'none' for smoother updates
            }
        } catch (error) {
            console.error('Error updating market data:', error);
        }
    }, 5000);

    // Store interval ID for cleanup
    window.marketDataInterval = updateInterval;
}

function cleanupMarketData() {
    if (window.marketDataInterval) {
        clearInterval(window.marketDataInterval);
        window.marketDataInterval = null;
    }

    // Clear time update interval if it exists
    const marketSection = document.querySelector('.market-data-section');
    if (marketSection && marketSection.dataset.timeInterval) {
        clearInterval(parseInt(marketSection.dataset.timeInterval));
        delete marketSection.dataset.timeInterval;
    }
}

function getNYSETime() {
    const nyTime = new Date().toLocaleString("en-US", {
        timeZone: "America/New_York",
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
    });
    return nyTime + " EST";
}

function createMarketDataSection(stockData) {
    // Load Chart.js if it's not already loaded
    if (!window.Chart) {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = () => initializeChart(document.getElementById('priceChart'));
        document.head.appendChild(script);
    }

    // Cleanup any existing interval
    cleanupMarketData();

    const marketDataSection = document.createElement('div');
    marketDataSection.className = 'market-data-section';
    
    marketDataSection.innerHTML = `
        <div class="market-header">
            <div class="market-title">
                <span class="company-name">${stockData.companyName}</span>
                <span class="company-symbol">${stockData.symbol}</span>
            </div>
            <div class="price-container">
                <span class="current-price">$${parseFloat(stockData.currentPrice).toFixed(2)}</span>
                <div class="price-change ${stockData.priceChange >= 0 ? 'positive' : 'negative'}">
                    <span>$${Math.abs(stockData.priceChange).toFixed(2)}</span>
                    <span>(${stockData.priceChangePercent}%)</span>
                </div>
            </div>
            
            <div class="controls-row">
                <div class="trading-status">
                    <span>${stockData.tradingStatus}</span>
                    <span class="separator">•</span>
                    <span>${stockData.lastUpdated}</span>
                </div>

                <div class="time-periods">
                    <button class="period-button active" data-period="1D">1D</button>
                    <button class="period-button" data-period="5D">5D</button>
                    <button class="period-button" data-period="1M">1M</button>
                    <button class="period-button" data-period="3M">3M</button>
                    <button class="period-button" data-period="6M">6M</button>
                    <button class="period-button" data-period="1Y">1Y</button>
                    <button class="period-button" data-period="5Y">5Y</button>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="priceChart" style="width: 100%; height: 100%;"></canvas>
        </div>
    `;

    // Add event listeners to period buttons
    const periodButtons = marketDataSection.querySelectorAll('.period-button');
    periodButtons.forEach(button => {
        button.addEventListener('click', () => {
            periodButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            if (window.Chart) {
                updateChart(button.dataset.period, stockData.symbol);
            }
        });
    });

    // Initialize chart after a small delay to ensure the canvas is ready
    setTimeout(() => {
        if (window.Chart) {
            initializeChart(marketDataSection.querySelector('#priceChart'), stockData);
        }
    }, 100);

    // Start real-time updates
    startMarketDataUpdates(stockData.symbol);

    return marketDataSection;
}

const typeButton = document.querySelector('.type-button'); // Changed from getElementById
const selectedType = document.querySelector('#selected-type');
const dropdownContent = document.querySelector('.dropdown-content');
const dropdownItems = document.querySelectorAll('.dropdown-item');

// Toggle dropdown on button click
typeButton.addEventListener('click', function(e) {
    e.preventDefault(); // Prevent any default button behavior
    e.stopPropagation(); // Prevent event bubbling
    dropdownContent.classList.toggle('show'); // Changed from add to toggle
});

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!typeButton.contains(e.target)) {
        dropdownContent.classList.remove('show');
    }
});

// Handle item selection
dropdownItems.forEach(item => {
    item.addEventListener('click', function(e) {
        e.stopPropagation(); // Prevent event bubbling
        selectedType.textContent = this.textContent;
        dropdownContent.classList.remove('show');
    });
});

// API configuration
// Define helper functions first
const API_KEYS = {
    finnhub: 'crnm7tpr01qt44di3q5gcrnm7tpr01qt44di3q60',
    marketaux: 'o4VnvcRmaBZeK4eBHPJr8KP3xN8gMBTedxHGkCNz',
    benzinga: '685f0ad2fe3f4facb3da0aeacb27b76b',
    nasdaq: 'VGV68j1nV9w9Zn3vwbsG',
    tavily: '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'
};

async function fetchMarketData(symbol) {
    try {
        const response = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${API_KEYS.finnhub}`);
        if (!response.ok) {
            throw new Error('Finnhub API error');
        }
        return await response.json();
    } catch (error) {
        console.error('Error fetching market data:', error);
        return null;
    }
}

async function performTavilySearch(symbol) {
    try {
        const response = await fetch('https://api.tavily.com/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                api_key: API_KEYS.tavily,
                query: `${symbol} stock financial information latest news`,
                search_depth: 'advanced',
                include_answer: true,
                max_results: 5
            })
        });
        return await response.json();
    } catch (error) {
        console.error('Error with Tavily search:', error);
        return null;
    }
}</script>

</body>
</html>
